<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Dev Task Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        #root { min-height: 100vh; }
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 0;
            background: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.75rem;
        }
        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 0.75rem;
        }
        
        /* Animations */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        @keyframes pulse-glow {
            0%, 100% { 
                transform: scale(1);
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.05);
                filter: brightness(1.2);
            }
        }
        @keyframes swing {
            0%, 100% { 
                transform: rotate(-15deg) translateY(0px);
            }
            50% { 
                transform: rotate(15deg) translateY(-10px);
            }
        }
        @keyframes moveToHeader {
            from {
                transform: translate(-50%, 0) scale(1);
            }
            to {
                transform: translate(-50%, calc(-50vh + 20px)) scale(0.5);
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        @keyframes fadeInContent {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        .animate-move-to-header { animation: moveToHeader 0.8s ease-in-out forwards; }
        .animate-fade-out { animation: fadeOut 0.4s ease-out forwards; }
        .animate-fade-in-content { animation: fadeInContent 0.8s ease-out 0.4s forwards; opacity: 0; }
        .hover-lift { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        
        /* Line clamp utility */
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-1:hover {
            -webkit-line-clamp: unset;
            line-clamp: unset;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Dynamic Background */
        .bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }
        
        .floating-controller {
            display: inline-block;
            opacity: 0.1;
            pointer-events: none;
            font-size: 50px;
            filter: grayscale(100%);
            flex-shrink: 0;
        }
        
        .scrolling-row {
            position: absolute;
            display: flex;
            gap: 30px;
            white-space: nowrap;
            align-items: center;
        }
        
        @keyframes scroll-infinite {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-50%);
            }
        }
        
        .content-wrapper {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Simple icon components
        const Plus = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
        const ChevronDown = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>;
        const ChevronRight = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>;
        const Check = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>;
        const Trash2 = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const Edit2 = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
        const Settings = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
        const Calendar = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>;
        const Moon = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>;
        const Sun = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>;
        const FileText = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
        const Layout = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>;
        const Sidebar = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h7" /></svg>;
        const Search = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
        const Download = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>;
        const Upload = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>;
        const BarChart = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>;
        const AlertCircle = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const X = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
        const Filter = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>;
        const ArrowUpDown = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>;
        const BookOpen = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>;
        const Palette = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>;
        const Code = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>;
        const Music = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>;
        const Package = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>;
        const LogOut = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>;
        const Users = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>;

        // Initialize Supabase
        const SUPABASE_URL = 'https://lfgmjorzkmxklgzipgys.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmZ21qb3J6a214a2xnemlwZ3lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzY0MjksImV4cCI6MjA3NzAxMjQyOX0.kCRrKubtApFZr3cNBttsmuenKHv0heqpL17a2vNe_Rw';
        
        // Check if Supabase library loaded
        if (typeof window.supabase === 'undefined') {
            console.error('❌ Supabase library failed to load! Check your internet connection.');
            alert('Failed to load Supabase library. Please check your internet connection and refresh the page.');
        }
        
        // Initialize Supabase client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('✅ Supabase client initialized:', supabaseClient ? 'Success' : 'Failed');

        const CATEGORIES = ['Story', 'Art', 'Programming', 'Sound', 'Other'];
        
        const getCategoryIcon = (category) => {
            const icons = {
                'Story': <BookOpen className="w-5 h-5" />,
                'Art': <Palette className="w-5 h-5" />,
                'Programming': <Code className="w-5 h-5" />,
                'Sound': <Music className="w-5 h-5" />,
                'Other': <Package className="w-5 h-5" />
            };
            return icons[category] || icons['Other'];
        };

        const getPriorityLevel = (priority) => {
            if (priority >= 60) return { text: 'CRITICAL', color: 'bg-red-600', icon: '🔥' };
            if (priority >= 40) return { text: 'URGENT', color: 'bg-orange-600', icon: '⚡' };
            if (priority >= 25) return { text: 'HIGH', color: 'bg-yellow-600', icon: '⚠' };
            if (priority >= 15) return { text: 'MEDIUM', color: 'bg-blue-600', icon: '📌' };
            if (priority >= 8) return { text: 'LOW', color: 'bg-green-600', icon: '✓' };
            return { text: 'MINIMAL', color: 'bg-gray-600', icon: '○' };
        };

        const calculateUrgency = (deadline) => {
            if (!deadline) return 1;
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const daysUntil = (deadlineDate - now) / (1000 * 60 * 60 * 24);
            
            if (daysUntil < 0) return 5;
            if (daysUntil < 1) return 4;
            if (daysUntil < 3) return 3;
            if (daysUntil < 7) return 2;
            return 1;
        };

        const calculatePriority = (task) => {
            const urgency = calculateUrgency(task.deadline);
            return task.importance * task.difficulty * urgency;
        };

        // Toast Notification Component
        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600',
                warning: 'bg-yellow-600'
            };

            return (
                <div className={`fixed bottom-6 right-6 ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 z-50 animate-slide-up`}>
                    <Check className="w-5 h-5" />
                    <span className="font-semibold">{message}</span>
                    <button onClick={onClose} className="ml-2 hover:opacity-80">
                        <X className="w-4 h-4" />
                    </button>
                </div>
            );
        };

        // Confirmation Dialog Component
        const ConfirmDialog = ({ title, message, onConfirm, onCancel, darkMode }) => {
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl animate-scale-in`}>
                        <div className="flex items-start gap-3 mb-4">
                            <AlertCircle className="w-6 h-6 text-red-600 flex-shrink-0 mt-1" />
                            <div>
                                <h3 className={`text-xl font-bold mb-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{title}</h3>
                                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{message}</p>
                            </div>
                        </div>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onCancel} className={`px-4 py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}>
                                Cancel
                            </button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded-lg font-semibold bg-red-600 hover:bg-red-700 text-white">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Header Logo Component
        const HeaderLogo = ({ darkMode }) => {
            return (
                <div className="flex items-center gap-3">
                    <div className="text-left">
                        <div className={`text-xs font-semibold tracking-wider uppercase ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Game Dev
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`text-xl font-black tracking-tight ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                TASK MANAGER
                            </div>
                            <span className="text-2xl inline-block" style={{
                                animation: 'swing 2s ease-in-out infinite',
                                transformOrigin: 'top center'
                            }}>
                                🎮
                            </span>
                        </div>
                    </div>
                </div>
            );
        };

        // Dynamic Background with Floating Controllers
        const DynamicBackground = ({ darkMode }) => {
            const rows = 15;
            const controllersPerRow = 40; // Enough to cover screen width
            const rowSpacing = 90;
            const duration = 30; // Same speed for all rows
            const rowOffset = 40; // Horizontal shift between rows

            return (
                <div className="bg-container">
                    {Array.from({ length: rows }, (_, rowIndex) => {
                        return (
                            <div
                                key={rowIndex}
                                className="scrolling-row"
                                style={{
                                    top: `${rowIndex * rowSpacing - 50}px`,
                                    left: `${-rowIndex * rowOffset}px`, // Offset each row to the left for stagger pattern
                                    animation: `scroll-infinite ${duration}s linear infinite`,
                                }}
                            >
                                {/* Duplicate the controllers twice for seamless infinite loop */}
                                {Array.from({ length: controllersPerRow * 2 }, (_, colIndex) => (
                                    <span
                                        key={`${rowIndex}-${colIndex}`}
                                        className="floating-controller"
                                    >
                                        🎮
                                    </span>
                                ))}
                            </div>
                        );
                    })}
                </div>
            );
        };

        const TaskItem = ({ task, onUpdate, onDelete, onToggle, level, colors, darkMode }) => {
            const [expanded, setExpanded] = useState(true);
            const [editing, setEditing] = useState(false);
            const [showNotes, setShowNotes] = useState(false);
            const [editData, setEditData] = useState(task);

            useEffect(() => {
                setEditData(task);
            }, [task]);

            const priority = calculatePriority(task);
            const priorityLevel = getPriorityLevel(priority);
            const hasSubtasks = task.subtasks && task.subtasks.length > 0;

            const handleSave = () => {
                onUpdate(editData);
                setEditing(false);
            };

            const handleAddSubtask = () => {
                const newSubtask = {
                    id: Date.now().toString(),
                    title: 'New subtask',
                    difficulty: 3,
                    importance: 3,
                    deadline: '',
                    notes: '',
                    completed: false,
                    subtasks: []
                };
                onUpdate({ ...task, subtasks: [...(task.subtasks || []), newSubtask] });
            };

            if (editing) {
                return (
                    <div className={`border-2 rounded-xl p-4 mb-3 ${darkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-200'}`} style={{ marginLeft: `${level * 24}px` }}>
                        <input type="text" value={editData.title} onChange={(e) => setEditData({ ...editData, title: e.target.value })} className={`w-full px-3 py-2 border rounded-lg mb-3 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white border-gray-300'}`} placeholder="Task title" />
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label className={`text-xs mb-1 block ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Difficulty: {editData.difficulty}</label>
                                <input type="range" min="1" max="5" value={editData.difficulty} onChange={(e) => setEditData({ ...editData, difficulty: parseInt(e.target.value) })} className="w-full" />
                            </div>
                            <div>
                                <label className={`text-xs mb-1 block ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Importance: {editData.importance}</label>
                                <input type="range" min="1" max="5" value={editData.importance} onChange={(e) => setEditData({ ...editData, importance: parseInt(e.target.value) })} className="w-full" />
                            </div>
                        </div>
                        <div className="mb-3">
                            <label className={`text-xs mb-1 block ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Deadline</label>
                            <input type="date" value={editData.deadline} onChange={(e) => setEditData({ ...editData, deadline: e.target.value })} className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white border-gray-300'}`} />
                        </div>
                        <div className="mb-3">
                            <label className={`text-xs mb-1 block ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Notes</label>
                            <textarea value={editData.notes || ''} onChange={(e) => setEditData({ ...editData, notes: e.target.value })} className={`w-full px-3 py-2 border rounded-lg min-h-20 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white border-gray-300'}`} placeholder="Add notes..." />
                        </div>
                        <div className="flex gap-2">
                            <button onClick={handleSave} className="px-4 py-2 text-white rounded-lg text-sm" style={{ backgroundColor: colors.primary }}>Save</button>
                            <button onClick={() => setEditing(false)} className={`px-4 py-2 rounded-lg text-sm ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200'}`}>Cancel</button>
                        </div>
                    </div>
                );
            }

            return (
                <div style={{ marginLeft: `${level * 24}px` }} className="mb-3">
                    <div className={`border-2 rounded-xl overflow-hidden ${task.completed ? darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-gray-50 border-gray-200' : darkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300 shadow-lg'}`}>
                        <div className={`${priorityLevel.color} px-4 py-2 flex items-center justify-between`}>
                            <span className="text-white font-bold text-sm flex items-center gap-2">{priorityLevel.icon} {priorityLevel.text} PRIORITY</span>
                            {task.deadline && (
                                <span className="text-white text-xs flex items-center gap-1 bg-black/20 px-2 py-1 rounded">
                                    <Calendar className="w-3 h-3" />
                                    {new Date(task.deadline).toLocaleDateString()}
                                </span>
                            )}
                        </div>
                        <div className="p-4">
                            <div className="flex items-start gap-3">
                                <div className="flex flex-col items-center gap-2">
                                    {hasSubtasks && (
                                        <button onClick={() => setExpanded(!expanded)} className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                                            {expanded ? <ChevronDown className="w-5 h-5" /> : <ChevronRight className="w-5 h-5" />}
                                        </button>
                                    )}
                                    <button onClick={() => onToggle(task.id)} className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center ${task.completed ? 'bg-green-500 border-green-500' : darkMode ? 'border-gray-500' : 'border-gray-400'}`}>
                                        {task.completed && <Check className="w-4 h-4 text-white" />}
                                    </button>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-start justify-between gap-3 mb-2">
                                        <h3 className={`font-bold text-xl ${task.completed ? `line-through ${darkMode ? 'text-gray-500' : 'text-gray-400'}` : darkMode ? 'text-white' : 'text-gray-800'}`}>{task.title}</h3>
                                        <div className="flex gap-2 flex-shrink-0">
                                            {task.notes && (
                                                <button onClick={() => setShowNotes(!showNotes)} className={`p-2 rounded-lg transition-all ${showNotes ? 'text-white' : darkMode ? 'text-gray-400' : 'text-gray-600'}`} style={showNotes ? { backgroundColor: colors.primary } : {}}>
                                                    <FileText className="w-4 h-4" />
                                                </button>
                                            )}
                                            <button onClick={() => setEditing(true)} className="p-2 rounded-lg" style={{ color: colors.primary }}>
                                                <Edit2 className="w-4 h-4" />
                                            </button>
                                            <button onClick={() => onDelete(task.id, task.title)} className="p-2 rounded-lg text-red-600">
                                                <Trash2 className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2 flex-wrap mb-2">
                                        <span className={`px-3 py-1 rounded-lg text-xs font-semibold ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'}`}>Difficulty: {task.difficulty}/5</span>
                                        <span className={`px-3 py-1 rounded-lg text-xs font-semibold ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'}`}>Importance: {task.importance}/5</span>
                                    </div>
                                    {!task.completed && (
                                        <button onClick={handleAddSubtask} className={`mt-3 px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`} style={{ color: colors.primary }}>
                                            <Plus className="w-4 h-4" /> Add Subtask
                                        </button>
                                    )}
                                </div>
                                {task.notes && showNotes && (
                                    <div className={`w-64 p-4 rounded-lg text-sm border-l-4 flex-shrink-0 ${darkMode ? 'bg-gray-700/50 text-gray-300 border-purple-500' : 'bg-blue-50 text-gray-700 border-blue-500'}`}>
                                        <div className="font-semibold mb-2 text-xs uppercase tracking-wide opacity-70 flex items-center gap-2"><FileText className="w-3 h-3" /> Notes</div>
                                        <div className="whitespace-pre-wrap text-xs leading-relaxed">{task.notes}</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    {expanded && hasSubtasks && (
                        <div className="mt-2">
                            {task.subtasks.map(subtask => (
                                <TaskItem key={subtask.id} task={subtask} onUpdate={(updated) => {
                                    const updatedSubtasks = task.subtasks.map(st => st.id === subtask.id ? updated : st);
                                    const allCompleted = updatedSubtasks.every(st => st.completed);
                                    onUpdate({ ...task, subtasks: updatedSubtasks, completed: allCompleted });
                                }} onDelete={(id) => {
                                    const updatedSubtasks = task.subtasks.filter(st => st.id !== id);
                                    onUpdate({ ...task, subtasks: updatedSubtasks });
                                }} onToggle={(id) => {
                                    const updatedSubtasks = task.subtasks.map(st => st.id === id ? { ...st, completed: !st.completed } : st);
                                    const allCompleted = updatedSubtasks.every(st => st.completed);
                                    onUpdate({ ...task, subtasks: updatedSubtasks, completed: allCompleted });
                                }} level={level + 1} colors={colors} darkMode={darkMode} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Auth Component - Login/Signup Page
        function AuthPage({ onAuthSuccess }) {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    if (isLogin) {
                        const { data, error } = await supabaseClient.auth.signInWithPassword({
                            email,
                            password,
                        });
                        if (error) throw error;
                        
                        // Check if user has a profile, if not create one
                        const { data: profile } = await supabaseClient
                            .from('user_profiles')
                            .select('username')
                            .eq('id', data.user.id)
                            .single();
                        
                        if (!profile) {
                            // User confirmed email but no profile yet - need to create one
                            setError('Please complete your profile by choosing a username');
                            return;
                        }
                        
                        onAuthSuccess(data.user);
                    } else {
                        // Signup flow - save username to metadata
                        const { data, error } = await supabaseClient.auth.signUp({
                            email,
                            password,
                            options: {
                                data: {
                                    username: username.toLowerCase().trim()
                                }
                            }
                        });
                        if (error) throw error;
                        
                        if (data.user) {
                            setError('Check your email to confirm your account!');
                        }
                    }
                } catch (error) {
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-900 flex items-center justify-center p-6 relative overflow-hidden">
                    <DynamicBackground darkMode={true} />
                    <div className="max-w-md w-full relative z-10">
                        {/* Logo */}
                        <div className="text-center mb-8">
                            <h2 className="text-3xl font-bold tracking-widest uppercase text-white mb-1">
                                Game Dev
                            </h2>
                            <div className="flex items-center justify-center gap-2">
                                <h1 className="text-5xl font-black tracking-tight text-white whitespace-nowrap">
                                    TASK MANAGER
                                </h1>
                                <span className="text-4xl">🎮</span>
                            </div>
                        </div>

                        {/* Auth Form */}
                        <div className="bg-white rounded-2xl shadow-2xl p-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">
                                {isLogin ? 'Welcome Back!' : 'Create Account'}
                            </h2>

                            {error && (
                                <div className={`p-4 rounded-lg mb-4 ${error.includes('Check your email') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                    {error}
                                </div>
                            )}

                            <form onSubmit={handleAuth} className="space-y-4">
                                {!isLogin && (
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Username
                                        </label>
                                        <input
                                            type="text"
                                            value={username}
                                            onChange={(e) => setUsername(e.target.value)}
                                            required
                                            pattern="[a-zA-Z0-9_]{3,20}"
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                                            placeholder="cooldev123"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">3-20 characters, letters, numbers, and underscores only</p>
                                    </div>
                                )}
                                
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        Email
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                                        placeholder="your@email.com"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        minLength={6}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                                        placeholder="••••••••"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl hover:scale-105 transition-transform disabled:opacity-50"
                                >
                                    {loading ? 'Loading...' : (isLogin ? 'Sign In' : 'Sign Up')}
                                </button>
                            </form>

                            <div className="mt-6 text-center">
                                <button
                                    onClick={() => {
                                        setIsLogin(!isLogin);
                                        setError('');
                                    }}
                                    className="text-purple-600 hover:text-purple-800 font-semibold"
                                >
                                    {isLogin ? "Don't have an account? Sign Up" : 'Already have an account? Sign In'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function GameDevTaskManager({ user }) {
            const [tasks, setTasks] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [projectName, setProjectName] = useState('My Game Project');
            const [projectDescription, setProjectDescription] = useState('');
            const [projectDeadline, setProjectDeadline] = useState('');
            const [editingProject, setEditingProject] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [primaryColor, setPrimaryColor] = useState('#9333ea');
            const [secondaryColor, setSecondaryColor] = useState('#ec4899');
            const [darkMode, setDarkMode] = useState(false);
            const [layoutStyle, setLayoutStyle] = useState('horizontal'); // 'horizontal' or 'sidebar'
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [projects, setProjects] = useState([]);
            const [showProjectSelector, setShowProjectSelector] = useState(false);
            const [showNewProjectInput, setShowNewProjectInput] = useState(false);
            const [newProjectName, setNewProjectName] = useState('');
            const [hasLoaded, setHasLoaded] = useState(false);
            const [showStartPage, setShowStartPage] = useState(true);
            const [isTransitioning, setIsTransitioning] = useState(false);
            const [globalDarkMode, setGlobalDarkMode] = useState(false);
            const [dashboardLayoutStyle, setDashboardLayoutStyle] = useState('grid'); // 'grid' or 'list'
            const [showDashboardSettings, setShowDashboardSettings] = useState(false);
            const [dashboardPrimaryColor, setDashboardPrimaryColor] = useState('#9333ea');
            const [dashboardSecondaryColor, setDashboardSecondaryColor] = useState('#ec4899');
            
            // New feature states
            const [searchQuery, setSearchQuery] = useState('');
            const [showSearch, setShowSearch] = useState(false);
            const [sortBy, setSortBy] = useState('priority'); // 'priority', 'deadline', 'name'
            const [showStatistics, setShowStatistics] = useState(false);
            const [toast, setToast] = useState(null);
            const [confirmDialog, setConfirmDialog] = useState(null);
            
            // Dashboard feature states
            const [dashboardSearchQuery, setDashboardSearchQuery] = useState('');
            const [showDashboardSearch, setShowDashboardSearch] = useState(false);
            const [showDashboardStatistics, setShowDashboardStatistics] = useState(false);
            const [editingDashboardProject, setEditingDashboardProject] = useState(null);
            const [editingDashboardProjectName, setEditingDashboardProjectName] = useState('');
            const [editingDashboardProjectDescription, setEditingDashboardProjectDescription] = useState('');
            const [editingDashboardProjectDeadline, setEditingDashboardProjectDeadline] = useState('');
            const [activeTab, setActiveTab] = useState('projects'); // 'projects' or 'ideas'
            
            // Future Ideas states
            const [futureIdeas, setFutureIdeas] = useState([]);
            const [showNewIdeaInput, setShowNewIdeaInput] = useState(false);
            const [newIdeaName, setNewIdeaName] = useState('');
            const [newIdeaDescription, setNewIdeaDescription] = useState('');
            const [editingIdea, setEditingIdea] = useState(null);
            const [editingIdeaName, setEditingIdeaName] = useState('');
            const [editingIdeaDescription, setEditingIdeaDescription] = useState('');
            
            // Group Project states
            const [showMembersModal, setShowMembersModal] = useState(false);
            const [projectMembers, setProjectMembers] = useState([]);
            const [newMemberUsername, setNewMemberUsername] = useState('');
            const [loadingMembers, setLoadingMembers] = useState(false);
            const [pendingInvitations, setPendingInvitations] = useState([]);
            const [userUsername, setUserUsername] = useState('');

            // Load user username
            useEffect(() => {
                if (!user) return;
                
                const loadUsername = async () => {
                    const { data, error } = await supabaseClient
                        .from('user_profiles')
                        .select('username')
                        .eq('id', user.id)
                        .single();
                    
                    if (data) {
                        setUserUsername(data.username);
                    }
                };
                
                loadUsername();
            }, [user]);

            // Load user preferences from localStorage
            useEffect(() => {
                const savedPrefs = localStorage.getItem('userPreferences');
                if (savedPrefs) {
                    try {
                        const prefs = JSON.parse(savedPrefs);
                        setGlobalDarkMode(prefs.globalDarkMode || false);
                        setDashboardLayoutStyle(prefs.dashboardLayoutStyle || 'grid');
                        setDashboardPrimaryColor(prefs.dashboardPrimaryColor || '#9333ea');
                        setDashboardSecondaryColor(prefs.dashboardSecondaryColor || '#ec4899');
                    } catch (e) {
                        console.error('Failed to load preferences:', e);
                    }
                }
            }, []);

            // Save user preferences to localStorage whenever they change
            useEffect(() => {
                const prefs = {
                    globalDarkMode,
                    dashboardLayoutStyle,
                    dashboardPrimaryColor,
                    dashboardSecondaryColor
                };
                localStorage.setItem('userPreferences', JSON.stringify(prefs));
            }, [globalDarkMode, dashboardLayoutStyle, dashboardPrimaryColor, dashboardSecondaryColor]);

            // Sync project dark mode with global dark mode when global changes
            useEffect(() => {
                if (currentProjectId) {
                    setDarkMode(globalDarkMode);
                }
            }, [globalDarkMode, currentProjectId]);

            // Load projects from Supabase
            useEffect(() => {
                if (!user) return;
                
                const loadProjects = async () => {
                    console.log('📥 Loading projects from Supabase...');
                    
                    // Load projects owned by user
                    const { data: ownedProjects, error: ownedError } = await supabaseClient
                        .from('projects')
                        .select('*')
                        .eq('owner_id', user.id);
                    
                    if (ownedError) {
                        console.error('❌ Error loading owned projects:', ownedError);
                    }
                    
                    // Load projects where user is a member
                    const { data: memberships } = await supabaseClient
                        .from('project_members')
                        .select('project_id')
                        .eq('user_id', user.id);
                    
                    let memberProjects = [];
                    if (memberships && memberships.length > 0) {
                        const projectIds = memberships.map(m => m.project_id);
                        const { data: sharedProjects } = await supabaseClient
                            .from('projects')
                            .select('*')
                            .in('id', projectIds);
                        if (sharedProjects) {
                            memberProjects = sharedProjects;
                        }
                    }
                    
                    // Combine owned and member projects
                    const allProjects = [...(ownedProjects || []), ...memberProjects];
                    console.log('✅ Loaded projects:', allProjects);
                    
                    let projectsToLoad = [];
                    
                    if (allProjects && allProjects.length > 0) {
                        projectsToLoad = allProjects;
                        console.log('   First project tasks:', allProjects[0]?.tasks);
                    } else {
                        // Create default project for new users
                        const defaultProject = {
                            name: 'My Game Project',
                            description: '',
                            deadline: '',
                            tasks: [],
                            primary_color: '#9333ea',
                            secondary_color: '#ec4899',
                            dark_mode: globalDarkMode,
                            layout_style: 'horizontal',
                            owner_id: user.id,
                            is_group_project: false
                        };
                        
                        const { data: newProject, error: insertError } = await supabaseClient
                            .from('projects')
                            .insert([defaultProject])
                            .select()
                            .single();
                        
                        if (!insertError && newProject) {
                            projectsToLoad = [newProject];
                        }
                    }
                    
                    setProjects(projectsToLoad);
                    
                    // Load ideas
                    const { data: ideasData } = await supabaseClient
                        .from('ideas')
                        .select('*')
                        .eq('user_id', user.id);
                    
                    if (ideasData) {
                        setFutureIdeas(ideasData.map(idea => ({
                            id: idea.id,
                            name: idea.name,
                            description: idea.description,
                            createdAt: idea.created_at
                        })));
                    }
                    
                    // Load pending invitations (project_name is now stored in the invitation)
                    const { data: invitesData, error: invitesError } = await supabaseClient
                        .from('project_invitations')
                        .select('*')
                        .eq('invited_user_id', user.id)
                        .eq('status', 'pending');
                    
                    console.log('📬 Pending invitations:', invitesData);
                    if (invitesError) console.error('Error loading invitations:', invitesError);
                    
                    if (invitesData && invitesData.length > 0) {
                        setPendingInvitations(invitesData);
                    } else {
                        setPendingInvitations([]);
                    }
                    
                    setHasLoaded(true);
                };
                
                loadProjects();
            }, [user]);


            // Auto-save to Supabase
            useEffect(() => {
                if (!hasLoaded || !user || !currentProjectId) return;
                
                const saveProject = async () => {
                    console.log('🔄 Auto-saving project...', { 
                        currentProjectId, 
                        projectName,
                        tasksCount: tasks.length,
                        tasks: tasks
                    });
                    const { data, error } = await supabaseClient
                        .from('projects')
                        .update({
                            name: projectName,
                            description: projectDescription,
                            deadline: projectDeadline,
                            tasks,
                            primary_color: primaryColor,
                            secondary_color: secondaryColor,
                            dark_mode: darkMode,
                            layout_style: layoutStyle
                        })
                        .eq('id', currentProjectId)
                        .select();
                    
                    if (error) {
                        console.error('❌ Error saving project:', error);
                    } else {
                        console.log('✅ Project saved successfully!', data);
                        console.log('   Saved tasks:', data[0]?.tasks);
                        
                        // Update local projects array to keep it in sync
                        if (data && data[0]) {
                            setProjects(prevProjects => 
                                prevProjects.map(p => 
                                    p.id === currentProjectId ? data[0] : p
                                )
                            );
                        }
                    }
                };
                
                const timeoutId = setTimeout(saveProject, 1000); // Debounce 1 second
                return () => clearTimeout(timeoutId);
            }, [tasks, projectName, projectDescription, projectDeadline, primaryColor, secondaryColor, darkMode, layoutStyle, currentProjectId, hasLoaded, user]);

            const getAllTasks = (taskList) => {
                let all = [];
                taskList.forEach(task => {
                    all.push(task);
                    if (task.subtasks?.length > 0) {
                        all = all.concat(getAllTasks(task.subtasks));
                    }
                });
                return all;
            };

            const calculateProgress = () => {
                const allTasks = getAllTasks(tasks);
                if (allTasks.length === 0) return 0;
                const totalWeight = allTasks.reduce((sum, t) => sum + (t.difficulty * t.importance), 0);
                const completedWeight = allTasks.filter(t => t.completed).reduce((sum, t) => sum + (t.difficulty * t.importance), 0);
                return totalWeight > 0 ? (completedWeight / totalWeight) * 100 : 0;
            };

            const addTask = (category) => {
                setTasks([...tasks, {
                    id: Date.now().toString(),
                    title: 'New Task',
                    category,
                    difficulty: 3,
                    importance: 3,
                    deadline: '',
                    notes: '',
                    completed: false,
                    subtasks: []
                }]);
            };

            const updateTask = (taskId, updatedTask) => {
                const updateRecursive = (taskList) => {
                    return taskList.map(task => {
                        if (task.id === taskId) return updatedTask;
                        if (task.subtasks?.length > 0) {
                            return { ...task, subtasks: updateRecursive(task.subtasks) };
                        }
                        return task;
                    });
                };
                setTasks(updateRecursive(tasks));
            };

            const deleteTask = (taskId, taskTitle = 'this task') => {
                setConfirmDialog({
                    title: 'Delete Task',
                    message: `Are you sure you want to delete "${taskTitle}"? This action cannot be undone.`,
                    onConfirm: () => {
                const deleteRecursive = (taskList) => {
                    return taskList.filter(task => {
                        if (task.id === taskId) return false;
                        if (task.subtasks?.length > 0) {
                            task.subtasks = deleteRecursive(task.subtasks);
                        }
                        return true;
                    });
                };
                setTasks(deleteRecursive(tasks));
                        setConfirmDialog(null);
                        showToast('Task deleted successfully', 'success');
                    },
                    onCancel: () => setConfirmDialog(null)
                });
            };

            const toggleTask = (taskId) => {
                const toggleRecursive = (taskList) => {
                    return taskList.map(task => {
                        if (task.id === taskId) {
                            const newCompleted = !task.completed;
                            return {
                                ...task,
                                completed: newCompleted,
                                subtasks: task.subtasks?.map(st => ({ ...st, completed: newCompleted }))
                            };
                        }
                        if (task.subtasks?.length > 0) {
                            return { ...task, subtasks: toggleRecursive(task.subtasks) };
                        }
                        return task;
                    });
                };
                setTasks(toggleRecursive(tasks));
            };

            const getFilteredTasks = () => {
                if (selectedCategory === 'All') return tasks;
                return tasks.filter(task => task.category === selectedCategory);
            };

            const getSortedTasks = () => {
                let filtered = [...getFilteredTasks()];
                
                // Apply search filter
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(task => 
                        task.title.toLowerCase().includes(query) ||
                        task.notes?.toLowerCase().includes(query) ||
                        task.category.toLowerCase().includes(query)
                    );
                }
                
                // Apply sorting
                return filtered.sort((a, b) => {
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    
                    switch (sortBy) {
                        case 'deadline':
                            if (!a.deadline && !b.deadline) return 0;
                            if (!a.deadline) return 1;
                            if (!b.deadline) return -1;
                            return new Date(a.deadline) - new Date(b.deadline);
                        case 'name':
                            return a.title.localeCompare(b.title);
                        case 'priority':
                        default:
                    return calculatePriority(b) - calculatePriority(a);
                    }
                });
            };
            
            // Export data to JSON
            const exportData = () => {
                const dataStr = JSON.stringify({
                    projects,
                    currentProjectId,
                    globalDarkMode,
                    dashboardLayoutStyle,
                    dashboardPrimaryColor,
                    dashboardSecondaryColor,
                    exportDate: new Date().toISOString()
                }, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `game-dev-tasks-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showToast('Data exported successfully!', 'success');
            };
            
            // Import data from JSON
            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (imported.projects) {
                            setProjects(imported.projects);
                            setGlobalDarkMode(imported.globalDarkMode || false);
                            setDashboardLayoutStyle(imported.dashboardLayoutStyle || 'grid');
                            setDashboardPrimaryColor(imported.dashboardPrimaryColor || '#9333ea');
                            setDashboardSecondaryColor(imported.dashboardSecondaryColor || '#ec4899');
                            // Note: Import now only loads to memory, not Supabase
                            showToast('Data imported successfully!', 'success');
                        } else {
                            showToast('Invalid file format', 'error');
                        }
                    } catch (error) {
                        showToast('Failed to import data', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            // Toast notification helper
            const showToast = (message, type = 'success') => {
                setToast({ message, type });
            };
            
            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyPress = (e) => {
                    // Ctrl/Cmd + K for search
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        setShowSearch(prev => !prev);
                    }
                    // Ctrl/Cmd + N for new task (when in a project)
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n' && currentProjectId) {
                        e.preventDefault();
                        addTask(selectedCategory === 'All' ? 'Other' : selectedCategory);
                        showToast('New task created!', 'info');
                    }
                    // Ctrl/Cmd + S for statistics
                    if ((e.ctrlKey || e.metaKey) && e.key === 's' && currentProjectId) {
                        e.preventDefault();
                        setShowStatistics(prev => !prev);
                    }
                    // Escape to close modals
                    if (e.key === 'Escape') {
                        setShowSearch(false);
                        setShowStatistics(false);
                        setShowSettings(false);
                        setConfirmDialog(null);
                    }
                };
                
                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [currentProjectId, selectedCategory]);

            const switchProject = (projectId) => {
                try {
                    console.log('Switching to project:', projectId);
                    // Load new project data
                    const newProject = projects.find(p => p.id === projectId);
                    console.log('Found project:', newProject);
                    if (newProject) {
                        // Update state
                        setCurrentProjectId(projectId);
                        setProjectName(newProject.name || 'Untitled Project');
                        setProjectDescription(newProject.description || '');
                        setProjectDeadline(newProject.deadline || '');
                        setTasks(Array.isArray(newProject.tasks) ? newProject.tasks : []);
                        setPrimaryColor(newProject.primary_color || newProject.primaryColor || '#9333ea');
                        setSecondaryColor(newProject.secondary_color || newProject.secondaryColor || '#ec4899');
                        setDarkMode(globalDarkMode); // Always use global dark mode
                        setLayoutStyle(newProject.layout_style || newProject.layoutStyle || 'horizontal');
                        setSelectedCategory('All');
                        setShowProjectSelector(false);
                        console.log('✅ Loaded tasks:', newProject.tasks?.length || 0);
                    } else {
                        console.error('❌ Project not found:', projectId);
                        showToast('Project not found', 'error');
                    }
                } catch (error) {
                    console.error('❌ Error switching project:', error);
                    showToast('Failed to load project', 'error');
                }
            };

            const createNewProject = async () => {
                if (!newProjectName.trim()) return;
                
                const newProject = {
                    name: newProjectName,
                    description: '',
                    deadline: '',
                    tasks: [],
                    primary_color: '#9333ea',
                    secondary_color: '#ec4899',
                    dark_mode: globalDarkMode,
                    layout_style: 'horizontal',
                    owner_id: user.id,
                    is_group_project: false
                };
                
                const { data, error } = await supabaseClient
                    .from('projects')
                    .insert([newProject])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Error creating project:', error);
                    showToast('Failed to create project', 'error');
                    return;
                }
                
                if (data) {
                    setProjects([...projects, data]);
                    setNewProjectName('');
                    setShowNewProjectInput(false);
                    switchProject(data.id);
                    showToast('Project created successfully!', 'success');
                }
            };

            const deleteProject = (projectId, projectName = 'this project') => {
                if (projects.length <= 1) {
                    showToast('Cannot delete the last project', 'warning');
                    return;
                }
                
                setConfirmDialog({
                    title: 'Delete Project',
                    message: `Are you sure you want to delete "${projectName}"? All tasks and data will be permanently lost.`,
                    onConfirm: async () => {
                        const { error } = await supabaseClient
                            .from('projects')
                            .delete()
                            .eq('id', projectId)
                            .eq('owner_id', user.id);
                        
                        if (error) {
                            console.error('Error deleting project:', error);
                            showToast('Failed to delete project', 'error');
                            setConfirmDialog(null);
                            return;
                        }
                        
                        const filtered = projects.filter(p => p.id !== projectId);
                        setProjects(filtered);
                        if (currentProjectId === projectId) {
                            switchProject(filtered[0].id);
                        }
                        setConfirmDialog(null);
                        showToast('Project deleted successfully', 'success');
                    },
                    onCancel: () => setConfirmDialog(null)
                });
            };

            const startEditingDashboardProject = (project) => {
                setEditingDashboardProject(project.id);
                setEditingDashboardProjectName(project.name);
                setEditingDashboardProjectDescription(project.description || '');
                setEditingDashboardProjectDeadline(project.deadline || '');
            };

            const saveDashboardProjectEdit = async () => {
                if (!editingDashboardProjectName.trim()) {
                    showToast('Project name cannot be empty', 'warning');
                    return;
                }
                
                const { error } = await supabaseClient
                    .from('projects')
                    .update({
                        name: editingDashboardProjectName,
                        description: editingDashboardProjectDescription,
                        deadline: editingDashboardProjectDeadline
                    })
                    .eq('id', editingDashboardProject);
                
                if (error) {
                    console.error('Error updating project:', error);
                    showToast('Failed to update project', 'error');
                    return;
                }
                
                const updatedProjects = projects.map(p => 
                    p.id === editingDashboardProject 
                        ? { ...p, name: editingDashboardProjectName, description: editingDashboardProjectDescription, deadline: editingDashboardProjectDeadline }
                        : p
                );
                setProjects(updatedProjects);
                
                // If editing the current project, update the local state too
                if (currentProjectId === editingDashboardProject) {
                    setProjectName(editingDashboardProjectName);
                    setProjectDescription(editingDashboardProjectDescription);
                    setProjectDeadline(editingDashboardProjectDeadline);
                }
                
                setEditingDashboardProject(null);
                showToast('Project updated successfully', 'success');
            };

            const cancelDashboardProjectEdit = () => {
                setEditingDashboardProject(null);
                setEditingDashboardProjectName('');
                setEditingDashboardProjectDescription('');
                setEditingDashboardProjectDeadline('');
            };

            // Future Ideas Management
            const addFutureIdea = async () => {
                if (!newIdeaName.trim()) {
                    showToast('Idea name cannot be empty', 'warning');
                    return;
                }
                
                const newIdea = {
                    name: newIdeaName,
                    description: newIdeaDescription,
                    user_id: user.id
                };
                
                const { data, error } = await supabaseClient
                    .from('ideas')
                    .insert([newIdea])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Error creating idea:', error);
                    showToast('Failed to add idea', 'error');
                    return;
                }
                
                if (data) {
                    setFutureIdeas([...futureIdeas, {
                        id: data.id,
                        name: data.name,
                        description: data.description,
                        createdAt: data.created_at
                    }]);
                    setNewIdeaName('');
                    setNewIdeaDescription('');
                    setShowNewIdeaInput(false);
                    showToast('Idea added successfully', 'success');
                }
            };

            const deleteIdea = (ideaId, ideaName) => {
                setConfirmDialog({
                    title: 'Delete Idea',
                    message: `Are you sure you want to delete "${ideaName}"? This action cannot be undone.`,
                    onConfirm: async () => {
                        const { error } = await supabaseClient
                            .from('ideas')
                            .delete()
                            .eq('id', ideaId)
                            .eq('user_id', user.id);
                        
                        if (error) {
                            console.error('Error deleting idea:', error);
                            showToast('Failed to delete idea', 'error');
                            setConfirmDialog(null);
                            return;
                        }
                        
                        setFutureIdeas(futureIdeas.filter(idea => idea.id !== ideaId));
                        setConfirmDialog(null);
                        showToast('Idea deleted successfully', 'success');
                    },
                    onCancel: () => setConfirmDialog(null)
                });
            };

            const startEditingIdea = (idea) => {
                setEditingIdea(idea.id);
                setEditingIdeaName(idea.name);
                setEditingIdeaDescription(idea.description || '');
            };

            const saveIdeaEdit = async () => {
                if (!editingIdeaName.trim()) {
                    showToast('Idea name cannot be empty', 'warning');
                    return;
                }
                
                const { error } = await supabaseClient
                    .from('ideas')
                    .update({
                        name: editingIdeaName,
                        description: editingIdeaDescription
                    })
                    .eq('id', editingIdea)
                    .eq('user_id', user.id);
                
                if (error) {
                    console.error('Error updating idea:', error);
                    showToast('Failed to update idea', 'error');
                    return;
                }
                
                setFutureIdeas(futureIdeas.map(idea => 
                    idea.id === editingIdea ? { ...idea, name: editingIdeaName, description: editingIdeaDescription } : idea
                ));
                setEditingIdea(null);
                setEditingIdeaName('');
                setEditingIdeaDescription('');
                showToast('Idea updated successfully', 'success');
            };

            const cancelIdeaEdit = () => {
                setEditingIdea(null);
                setEditingIdeaName('');
                setEditingIdeaDescription('');
            };

            // Group Project Member Management
            const loadProjectMembers = async (projectId) => {
                setLoadingMembers(true);
                const { data, error } = await supabaseClient
                    .from('project_members')
                    .select('*')
                    .eq('project_id', projectId);
                
                if (error) {
                    console.error('Error loading members:', error);
                    setProjectMembers([]);
                } else {
                    // Load user details for each member
                    if (data && data.length > 0) {
                        const membersWithDetails = await Promise.all(
                            data.map(async (member) => {
                                const { data: profile } = await supabaseClient
                                    .from('user_profiles')
                                    .select('username')
                                    .eq('id', member.user_id)
                                    .single();
                                return { ...member, username: profile?.username || 'Unknown' };
                            })
                        );
                        setProjectMembers(membersWithDetails);
                    } else {
                        setProjectMembers([]);
                    }
                }
                setLoadingMembers(false);
            };

            const addProjectMember = async (username) => {
                if (!username.trim() || !currentProjectId) return;
                
                try {
                    // Find user by username
                    const { data: targetUser, error: userError } = await supabaseClient
                        .from('user_profiles')
                        .select('id, username')
                        .eq('username', username.toLowerCase().trim())
                        .single();
                    
                    if (userError || !targetUser) {
                        showToast('User not found!', 'error');
                        return;
                    }
                    
                    // Create invitation with project name
                    const { error: inviteError } = await supabaseClient
                        .from('project_invitations')
                        .insert([{
                            project_id: currentProjectId,
                            invited_by: user.id,
                            invited_username: userUsername, // Save the INVITER's username
                            invited_user_id: targetUser.id,
                            project_name: projectName, // Save project name so invited user can see it
                            status: 'pending'
                        }]);
                    
                    if (inviteError) {
                        if (inviteError.code === '23505') {
                            showToast('User already invited or is a member!', 'warning');
                        } else {
                            throw inviteError;
                        }
                        return;
                    }
                    
                    showToast(`Invitation sent to @${targetUser.username}!`, 'success');
                    setNewMemberUsername('');
                } catch (error) {
                    console.error('Error inviting member:', error);
                    showToast('Failed to send invitation', 'error');
                }
            };

            const removeProjectMember = async (memberId) => {
                const { error } = await supabaseClient
                    .from('project_members')
                    .delete()
                    .eq('id', memberId);
                
                if (error) {
                    console.error('Error removing member:', error);
                    showToast('Failed to remove member', 'error');
                } else {
                    showToast('Member removed successfully', 'success');
                    loadProjectMembers(currentProjectId);
                }
            };

            const acceptInvitation = async (invitationId, projectId) => {
                try {
                    // Add user to project_members
                    const { error: memberError } = await supabaseClient
                        .from('project_members')
                        .insert([{
                            project_id: projectId,
                            user_id: user.id,
                            role: 'member'
                        }]);
                    
                    if (memberError) throw memberError;
                    
                    // Update invitation status
                    const { error: updateError } = await supabaseClient
                        .from('project_invitations')
                        .update({ status: 'accepted' })
                        .eq('id', invitationId);
                    
                    if (updateError) throw updateError;
                    
                    // Reload all projects (owned + member projects)
                    const { data: ownedProjects } = await supabaseClient
                        .from('projects')
                        .select('*')
                        .eq('owner_id', user.id);
                    
                    const { data: memberships } = await supabaseClient
                        .from('project_members')
                        .select('project_id')
                        .eq('user_id', user.id);
                    
                    let memberProjects = [];
                    if (memberships && memberships.length > 0) {
                        const projectIds = memberships.map(m => m.project_id);
                        const { data: sharedProjects } = await supabaseClient
                            .from('projects')
                            .select('*')
                            .in('id', projectIds);
                        if (sharedProjects) {
                            memberProjects = sharedProjects;
                        }
                    }
                    
                    const allProjects = [...(ownedProjects || []), ...memberProjects];
                    setProjects(allProjects);
                    
                    setPendingInvitations(prev => prev.filter(inv => inv.id !== invitationId));
                    showToast('Invitation accepted!', 'success');
                } catch (error) {
                    console.error('Error accepting invitation:', error);
                    showToast('Failed to accept invitation', 'error');
                }
            };

            const declineInvitation = async (invitationId) => {
                try {
                    const { error } = await supabaseClient
                        .from('project_invitations')
                        .update({ status: 'declined' })
                        .eq('id', invitationId);
                    
                    if (error) throw error;
                    
                    setPendingInvitations(prev => prev.filter(inv => inv.id !== invitationId));
                    showToast('Invitation declined', 'success');
                } catch (error) {
                    console.error('Error declining invitation:', error);
                    showToast('Failed to decline invitation', 'error');
                }
            };

            const progress = calculateProgress();
            const colors = { primary: primaryColor, secondary: secondaryColor };
            const isCategoryView = selectedCategory !== 'All';

            const renderHorizontalLayout = () => {
                // In horizontal layout, show only the selected category
                const categoriesToShow = selectedCategory === 'All' ? CATEGORIES : [selectedCategory];
                
                return (
                    <div className="space-y-8">
                        {categoriesToShow.map(category => {
                            const categoryTasks = tasks.filter(t => t.category === category);
                            
                            const sortedTasks = categoryTasks.sort((a, b) => {
                                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                                return calculatePriority(b) - calculatePriority(a);
                            });
                            
                            const isSelected = selectedCategory === category;
                            const borderColor = isSelected ? primaryColor : (darkMode ? 'border-gray-700' : 'border-gray-200');
                            
                            return (
                                <div key={category} className={`border-2 rounded-2xl p-6 ${darkMode ? 'bg-gray-900/30' : 'bg-gradient-to-br from-gray-50 to-white'}`} style={isSelected ? { borderColor: primaryColor } : {}}>
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{category}</h2>
                                        <button onClick={() => {
                                            setSelectedCategory(category);
                                            addTask(category);
                                        }} className="px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 text-sm hover:scale-105 transition-transform" style={{ background: `linear-gradient(135deg, ${primaryColor}, ${secondaryColor})` }}>
                                            <Plus className="w-4 h-4" /> Add Task
                                        </button>
                                    </div>
                                    {sortedTasks.length === 0 ? (
                                        <div className={`text-center py-8 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                            <p className="text-sm">No tasks yet. Click "Add Task" to get started!</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {sortedTasks.map(task => (
                                                <TaskItem key={task.id} task={task} onUpdate={(updated) => updateTask(task.id, updated)} onDelete={deleteTask} onToggle={toggleTask} level={0} colors={colors} darkMode={darkMode} />
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                );
            };

            // Render the header logo (visible during and after transition)
            const renderHeaderLogo = () => {
                if (showStartPage && !isTransitioning) return null;
                if (isTransitioning) return null; // Logo animates in the start page during transition
                
                return (
                    <div className="absolute left-1/2 text-center" style={{ top: '20px', transform: 'translate(-50%, 0) scale(0.5)', zIndex: 50 }}>
                        <div style={{ marginBottom: '19px' }}>
                            <div className="flex flex-col items-center">
                                <h2 className={`text-4xl md:text-5xl font-bold tracking-widest uppercase ${globalDarkMode ? 'text-white' : 'text-gray-900'}`} style={{ marginBottom: '-2px' }}>
                                    Game Dev
                                </h2>
                                <div className="relative inline-block">
                                    <h1 className={`text-7xl md:text-9xl font-black tracking-tight whitespace-nowrap ${globalDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                        TASK MANAGER
                                    </h1>
                                    <span 
                                        className="text-5xl md:text-6xl absolute inline-block"
                                        style={{
                                            animation: 'swing 2s ease-in-out infinite',
                                            transformOrigin: 'top left',
                                            bottom: '-21px',
                                            right: '-47px'
                                        }}
                                    >
                                        🎮
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Show start page or transitioning
            if (showStartPage || isTransitioning) {
                return (
                    <div className={`min-h-screen flex items-center justify-center overflow-hidden relative ${globalDarkMode ? 'bg-gray-900' : 'bg-white'}`}>
                        {/* Background Controllers */}
                        <DynamicBackground darkMode={globalDarkMode} />

                        {/* Main Content */}
                        <div className={`relative z-10 text-center ${isTransitioning ? '' : 'animate-scale-in'}`}>
                            {/* Logo */}
                            <div className={isTransitioning ? 'animate-move-to-header' : ''} style={isTransitioning ? { marginBottom: '19px', position: 'fixed', left: '50%', top: '50vh', transform: 'translate(-50%, -50%)' } : { marginBottom: '19px' }}>
                                <div className="flex flex-col items-center">
                                    <h2 className={`text-4xl md:text-5xl font-bold tracking-widest uppercase ${globalDarkMode ? 'text-white' : 'text-gray-900'}`} style={{ marginBottom: '-2px' }}>
                                        Game Dev
                                    </h2>
                                    <div className="relative inline-block">
                                        <h1 className={`text-7xl md:text-9xl font-black tracking-tight whitespace-nowrap ${globalDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                            TASK MANAGER
                                        </h1>
                                        <span 
                                            className="text-5xl md:text-6xl absolute inline-block"
                                            style={{
                                                animation: 'swing 2s ease-in-out infinite',
                                                transformOrigin: 'top left',
                                                bottom: '-21px',
                                                right: '-47px'
                                            }}
                                        >
                                            🎮
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* Tagline and Start Button */}
                            {!isTransitioning && (
                                <>
                                    <p className={`mb-6 text-xl ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>Organize your game development projects</p>
                                    
                                    <button 
                                        onClick={() => {
                                            setIsTransitioning(true);
                                            setTimeout(() => {
                                                setShowStartPage(false);
                                                setIsTransitioning(false);
                                            }, 800);
                                        }}
                                        className="group relative px-12 py-5 rounded-2xl font-bold text-3xl hover:scale-110 transition-all duration-300 shadow-2xl"
                                        style={{
                                            background: globalDarkMode ? 'linear-gradient(135deg, #9333ea, #ec4899)' : 'linear-gradient(135deg, #9333ea, #ec4899)',
                                            color: 'white'
                                        }}
                                    >
                                        START NOW
                                    </button>
                                </>
                            )}
                            {isTransitioning && (
                                <>
                                    <p className={`mb-6 text-xl animate-fade-out ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>Organize your game development projects</p>
                                    
                                    <button 
                                        className="group relative px-12 py-5 rounded-2xl font-bold text-3xl shadow-2xl animate-fade-out"
                                        style={{
                                            background: globalDarkMode ? 'linear-gradient(135deg, #9333ea, #ec4899)' : 'linear-gradient(135deg, #9333ea, #ec4899)',
                                            color: 'white'
                                        }}
                                        disabled
                                    >
                                        START NOW
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            // Show dashboard when no project is loaded
            if (!currentProjectId || !hasLoaded) {
                return (
                    <div className={`min-h-screen p-6 ${globalDarkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-purple-50 to-pink-50'}`}>
                        <DynamicBackground darkMode={globalDarkMode} />
                        {renderHeaderLogo()}
                        <div className="max-w-6xl mx-auto content-wrapper animate-fade-in-content" style={{ paddingTop: '180px' }}>
                            <div className={`rounded-3xl shadow-2xl p-12 ${globalDarkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                <div className="mb-8">
                                    <h2 className={`text-3xl font-semibold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>
                                        Welcome, {userUsername ? `@${userUsername}` : 'Game Dev'} 👋
                                    </h2>
                                </div>

                                {/* Pending Invitations */}
                                {pendingInvitations.length > 0 && (
                                    <div className={`mb-8 p-6 rounded-2xl border-2 animate-scale-in ${globalDarkMode ? 'bg-purple-900/20 border-purple-500/50' : 'bg-purple-50 border-purple-300'}`}>
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: dashboardPrimaryColor }}>
                                                <span className="text-white font-bold text-lg">{pendingInvitations.length}</span>
                                            </div>
                                            <h3 className={`text-xl font-bold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>
                                                Pending Invitations
                                            </h3>
                                        </div>
                                        <div className="space-y-3">
                                            {pendingInvitations.map(invite => (
                                                <div key={invite.id} className={`p-4 rounded-xl ${globalDarkMode ? 'bg-gray-800' : 'bg-white'} flex items-center justify-between`}>
                                                    <div>
                                                        <p className={`font-semibold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>
                                                            {invite.project_name || 'Project'}
                                                        </p>
                                                        <p className={`text-sm ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                            Invited by @{invite.invited_username || 'someone'}
                                                        </p>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button 
                                                            onClick={() => acceptInvitation(invite.id, invite.project_id)}
                                                            className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold text-sm"
                                                        >
                                                            Accept
                                                        </button>
                                                        <button 
                                                            onClick={() => declineInvitation(invite.id)}
                                                            className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold text-sm"
                                                        >
                                                            Decline
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="flex items-center justify-between mb-12">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-6">
                                            <button 
                                                onClick={() => setActiveTab('projects')} 
                                                className={`text-4xl font-bold pb-2 transition-all ${activeTab === 'projects' ? (globalDarkMode ? 'text-white border-b-4' : 'text-gray-800 border-b-4') : (globalDarkMode ? 'text-gray-500' : 'text-gray-400')}`}
                                                style={activeTab === 'projects' ? { borderColor: dashboardPrimaryColor } : {}}
                                            >
                                                My Projects
                                            </button>
                                            <button 
                                                onClick={() => setActiveTab('ideas')} 
                                                className={`text-4xl font-bold pb-2 transition-all ${activeTab === 'ideas' ? (globalDarkMode ? 'text-white border-b-4' : 'text-gray-800 border-b-4') : (globalDarkMode ? 'text-gray-500' : 'text-gray-400')}`}
                                                style={activeTab === 'ideas' ? { borderColor: dashboardPrimaryColor } : {}}
                                            >
                                                Future Ideas
                                            </button>
                                        </div>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => setGlobalDarkMode(!globalDarkMode)} className={`p-3 rounded-xl ${globalDarkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-100'}`}>
                                            {globalDarkMode ? <Moon className="w-6 h-6" /> : <Sun className="w-6 h-6" />}
                                        </button>
                                        <button onClick={() => setDashboardLayoutStyle(dashboardLayoutStyle === 'grid' ? 'list' : 'grid')} className={`p-3 rounded-xl ${globalDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`} style={{ color: dashboardPrimaryColor }} title="Toggle Layout">
                                            {dashboardLayoutStyle === 'grid' ? <Sidebar className="w-6 h-6" /> : <Layout className="w-6 h-6" />}
                                        </button>
                                        <button onClick={() => setShowDashboardSearch(!showDashboardSearch)} className={`p-3 rounded-xl ${globalDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`} title="Search Projects">
                                            <Search className="w-6 h-6" style={{ color: dashboardPrimaryColor }} />
                                        </button>
                                        <button onClick={() => setShowDashboardStatistics(!showDashboardStatistics)} className={`p-3 rounded-xl ${globalDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`} title="Statistics">
                                            <BarChart className="w-6 h-6" style={{ color: dashboardPrimaryColor }} />
                                        </button>
                                        <button onClick={() => setShowDashboardSettings(!showDashboardSettings)} className={`p-3 rounded-xl ${globalDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`} style={{ color: dashboardPrimaryColor }}>
                                            <Settings className="w-6 h-6" />
                                        </button>
                                        <button onClick={async () => {
                                            await supabaseClient.auth.signOut();
                                            window.location.reload();
                                        }} className={`p-3 rounded-xl ${globalDarkMode ? 'bg-red-700 hover:bg-red-600' : 'bg-red-100 hover:bg-red-200'}`} title="Logout">
                                            <LogOut className="w-6 h-6 text-red-600" />
                                        </button>
                                        <button onClick={() => activeTab === 'projects' ? setShowNewProjectInput(true) : setShowNewIdeaInput(true)} className="px-6 py-3 text-white rounded-xl font-semibold flex items-center gap-2 shadow-lg hover:shadow-xl transition-all" style={{ background: `linear-gradient(135deg, ${dashboardPrimaryColor}, ${dashboardSecondaryColor})` }}>
                                            <Plus className="w-5 h-5" /> {activeTab === 'projects' ? 'New Project' : 'New Idea'}
                                        </button>
                                    </div>
                                </div>
                                
                                {showDashboardSettings && (
                                    <div className={`mb-8 p-6 rounded-xl ${globalDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                        <h3 className={`font-bold mb-4 ${globalDarkMode ? 'text-white' : ''}`}>Dashboard Settings</h3>
                                        <div className="mb-6">
                                            <h4 className={`font-semibold mb-3 text-sm ${globalDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>Colors</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className={`text-sm mb-2 block ${globalDarkMode ? 'text-gray-300' : ''}`}>Primary</label>
                                                    <input type="color" value={dashboardPrimaryColor} onChange={(e) => setDashboardPrimaryColor(e.target.value)} className="w-full h-12 rounded-xl" />
                                                </div>
                                                <div>
                                                    <label className={`text-sm mb-2 block ${globalDarkMode ? 'text-gray-300' : ''}`}>Secondary</label>
                                                    <input type="color" value={dashboardSecondaryColor} onChange={(e) => setDashboardSecondaryColor(e.target.value)} className="w-full h-12 rounded-xl" />
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className={`font-semibold mb-3 text-sm ${globalDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>Data Management</h4>
                                            <div className="flex gap-3">
                                                <button onClick={exportData} className={`flex-1 px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 ${globalDarkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-white hover:bg-gray-50 border-2 border-gray-300'}`}>
                                                    <Download className="w-5 h-5" />
                                                    Export Data
                                                </button>
                                                <label className={`flex-1 px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 cursor-pointer ${globalDarkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-white hover:bg-gray-50 border-2 border-gray-300'}`}>
                                                    <Upload className="w-5 h-5" />
                                                    Import Data
                                                    <input type="file" accept=".json" onChange={importData} className="hidden" />
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {showNewProjectInput && (
                                    <div className={`mb-8 p-6 rounded-xl ${globalDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                        <div className="flex gap-3">
                                            <input 
                                                type="text" 
                                                value={newProjectName} 
                                                onChange={(e) => setNewProjectName(e.target.value)} 
                                                onKeyPress={(e) => e.key === 'Enter' && createNewProject()} 
                                                className={`flex-1 px-4 py-3 border-2 rounded-xl text-lg font-semibold ${globalDarkMode ? 'bg-gray-600 text-white border-gray-500' : 'bg-white border-gray-300'}`} 
                                                placeholder="Project name" 
                                                autoFocus 
                                            />
                                            <button onClick={createNewProject} className="px-6 py-3 text-white rounded-xl font-semibold" style={{ background: `linear-gradient(135deg, #9333ea, #ec4899)` }}>
                                                Create
                                            </button>
                                            <button onClick={() => {setShowNewProjectInput(false); setNewProjectName('');}} className={`px-6 py-3 rounded-xl font-semibold ${globalDarkMode ? 'bg-gray-700 text-white' : 'bg-gray-200'}`}>
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {showNewIdeaInput && (
                                    <div className={`mb-8 p-6 rounded-xl ${globalDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                        <div className="space-y-3">
                                            <input 
                                                type="text" 
                                                value={newIdeaName} 
                                                onChange={(e) => setNewIdeaName(e.target.value)} 
                                                className={`w-full px-4 py-3 border-2 rounded-xl text-lg font-semibold ${globalDarkMode ? 'bg-gray-600 text-white border-gray-500' : 'bg-white border-gray-300'}`} 
                                                placeholder="Idea name" 
                                                autoFocus 
                                            />
                                            <textarea 
                                                value={newIdeaDescription} 
                                                onChange={(e) => setNewIdeaDescription(e.target.value)} 
                                                className={`w-full px-4 py-3 border-2 rounded-xl resize-none ${globalDarkMode ? 'bg-gray-600 text-white border-gray-500 placeholder-gray-400' : 'bg-white border-gray-300'}`} 
                                                placeholder="Describe your idea..."
                                                rows="3"
                                            />
                                            <div className="flex gap-3 justify-end">
                                                <button onClick={() => {setShowNewIdeaInput(false); setNewIdeaName(''); setNewIdeaDescription('');}} className={`px-6 py-3 rounded-xl font-semibold ${globalDarkMode ? 'bg-gray-600 text-white' : 'bg-gray-200'}`}>
                                                    Cancel
                                                </button>
                                                <button onClick={addFutureIdea} className="px-6 py-3 text-white rounded-xl font-semibold" style={{ background: `linear-gradient(135deg, ${dashboardPrimaryColor}, ${dashboardSecondaryColor})` }}>
                                                    Add Idea
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Dashboard Search */}
                                {showDashboardSearch && (
                                    <div className="mb-8 animate-scale-in">
                                        <div className="relative">
                                            <Search className={`absolute left-4 top-1/2 transform -translate-y-1/2 w-6 h-6 ${globalDarkMode ? 'text-gray-400' : 'text-gray-500'}`} />
                                            <input 
                                                type="text" 
                                                value={dashboardSearchQuery} 
                                                onChange={(e) => setDashboardSearchQuery(e.target.value)}
                                                placeholder={activeTab === 'projects' ? "Search projects by name..." : "Search ideas by name..."}
                                                className={`w-full pl-14 pr-12 py-4 rounded-xl border-2 text-lg ${globalDarkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 placeholder-gray-500'}`}
                                                autoFocus
                                            />
                                            {dashboardSearchQuery && (
                                                <button onClick={() => setDashboardSearchQuery('')} className={`absolute right-4 top-1/2 transform -translate-y-1/2 ${globalDarkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-700'}`}>
                                                    <X className="w-6 h-6" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Dashboard Statistics */}
                                {showDashboardStatistics && (
                                    <div className={`mb-8 p-6 rounded-xl animate-scale-in ${globalDarkMode ? 'bg-gradient-to-br from-purple-900/30 to-pink-900/30 border-2 border-purple-500/50' : 'bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200'}`}>
                                        <div className="flex items-center justify-between mb-6">
                                            <h3 className={`text-2xl font-bold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>📊 All Projects Statistics</h3>
                                            <button onClick={() => setShowDashboardStatistics(false)} className={`p-2 rounded-lg ${globalDarkMode ? 'hover:bg-gray-700' : 'hover:bg-white/50'}`}>
                                                <X className="w-5 h-5" />
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                            {(() => {
                                                const allTasks = projects.flatMap(p => getAllTasks(p.tasks || []));
                                                const completedCount = allTasks.filter(t => t.completed).length;
                                                const withDeadlines = allTasks.filter(t => t.deadline && !t.completed).length;
                                                const overdue = allTasks.filter(t => t.deadline && !t.completed && new Date(t.deadline) < new Date()).length;
                                                
                                                const stats = [
                                                    { label: 'Total Projects', value: projects.length, icon: '📁', color: 'blue' },
                                                    { label: 'Total Tasks', value: allTasks.length, icon: '📝', color: 'purple' },
                                                    { label: 'Completed', value: completedCount, icon: '✅', color: 'green' },
                                                    { label: 'Overdue', value: overdue, icon: '⚠️', color: 'red' }
                                                ];
                                                
                                                return stats.map((stat, idx) => (
                                                    <div key={idx} className={`p-4 rounded-xl ${globalDarkMode ? 'bg-gray-800/50' : 'bg-white/70'}`}>
                                                        <div className="text-4xl mb-2">{stat.icon}</div>
                                                        <div className={`text-3xl font-bold mb-1 ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>{stat.value}</div>
                                                        <div className={`text-sm ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>{stat.label}</div>
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            {projects.map(project => {
                                                const projectTasks = getAllTasks(project.tasks || []);
                                                const completed = projectTasks.filter(t => t.completed).length;
                                                const progress = projectTasks.length > 0 ? (completed / projectTasks.length) * 100 : 0;
                                                
                                                return (
                                                    <div key={project.id} className={`p-4 rounded-xl ${globalDarkMode ? 'bg-gray-800/50' : 'bg-white/70'}`}>
                                                        <h4 className={`font-bold mb-2 truncate ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>{project.name}</h4>
                                                        <div className="flex items-center justify-between mb-2">
                                                            <span className={`text-sm ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>{projectTasks.length} tasks</span>
                                                            <span className={`text-lg font-bold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>{progress.toFixed(0)}%</span>
                                                        </div>
                                                        <div className={`w-full h-2 rounded-full ${globalDarkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                                                            <div className="h-2 rounded-full transition-all" style={{ width: `${progress}%`, background: `linear-gradient(90deg, ${dashboardPrimaryColor}, ${dashboardSecondaryColor})` }} />
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'projects' ? (
                                    <>
                                {projects.length === 0 ? (
                                    <div className={`text-center py-20 ${globalDarkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                                        <p className="text-2xl mb-4">No projects yet</p>
                                        <p className="text-lg">Click "New Project" to get started!</p>
                                    </div>
                                ) : (
                                    <>
                                        {/* Nearest Deadlines Section */}
                                        {(() => {
                                            const allTasksWithDeadlines = [];
                                            projects.forEach(project => {
                                                // Add project deadline if it exists
                                                if (project.deadline) {
                                                    allTasksWithDeadlines.push({
                                                        id: `project-${project.id}`,
                                                        title: `Project: ${project.name}`,
                                                        deadline: project.deadline,
                                                        projectName: project.name,
                                                        projectId: project.id,
                                                        category: 'Project Deadline',
                                                        isProjectDeadline: true
                                                    });
                                                }
                                                
                                                const projectTasks = project.tasks || [];
                                                const getAllTasksRecursive = (tasks, projectRef) => {
                                                    tasks.forEach(task => {
                                                        if (task.deadline && !task.completed) {
                                                            allTasksWithDeadlines.push({ ...task, projectName: projectRef.name, projectId: projectRef.id });
                                                        }
                                                        if (task.subtasks && task.subtasks.length > 0) {
                                                            getAllTasksRecursive(task.subtasks, projectRef);
                                                        }
                                                    });
                                                };
                                                getAllTasksRecursive(projectTasks, project);
                                            });
                                            
                                            // Filter to only show deadlines within next 7 days
                                            const now = new Date();
                                            const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                                            const deadlinesWithinWeek = allTasksWithDeadlines.filter(item => {
                                                const deadline = new Date(item.deadline);
                                                return deadline <= sevenDaysFromNow;
                                            });
                                            
                                            deadlinesWithinWeek.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                                            const upcomingDeadlines = deadlinesWithinWeek.slice(0, 5);
                                            
                                            if (upcomingDeadlines.length > 0) {
                                                return (
                                                    <div className={`border-2 rounded-2xl p-6 mb-6 ${globalDarkMode ? 'border-orange-500/50 bg-gradient-to-br from-orange-900/20 to-red-900/20' : 'border-orange-300 bg-gradient-to-br from-orange-50 to-red-50'}`}>
                                                        <div className="flex items-center gap-3 mb-4">
                                                            <Calendar className={`w-6 h-6 ${globalDarkMode ? 'text-orange-400' : 'text-orange-600'}`} />
                                                            <h2 className={`text-2xl font-bold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>Nearest Deadlines</h2>
                                                        </div>
                                                        <div className="space-y-3">
                                                            {upcomingDeadlines.map((task, index) => {
                                                                const deadline = new Date(task.deadline);
                                                                const now = new Date();
                                                                const daysUntil = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                                                                const isPast = daysUntil < 0;
                                                                const isToday = daysUntil === 0;
                                                                const isUrgent = daysUntil <= 3 && daysUntil >= 0;
                                                                
                                                                let urgencyColor = globalDarkMode ? 'bg-gray-700' : 'bg-gray-100';
                                                                let urgencyText = `${daysUntil} days`;
                                                                
                                                                if (isPast) {
                                                                    urgencyColor = 'bg-red-600';
                                                                    urgencyText = 'OVERDUE';
                                                                } else if (isToday) {
                                                                    urgencyColor = 'bg-orange-600';
                                                                    urgencyText = 'TODAY';
                                                                } else if (isUrgent) {
                                                                    urgencyColor = 'bg-yellow-600';
                                                                    urgencyText = `${daysUntil} day${daysUntil === 1 ? '' : 's'}`;
                                                                } else if (daysUntil === 1) {
                                                                    urgencyText = 'Tomorrow';
                                                                }
                                                                
                                                                return (
                                                                    <div key={`${task.projectId}-${task.id}-${index}`} className={`border rounded-xl p-4 cursor-pointer transition-all hover:shadow-lg ${globalDarkMode ? 'border-gray-700 bg-gray-800 hover:bg-gray-750' : 'border-gray-200 bg-white hover:bg-gray-50'}`} onClick={() => switchProject(task.projectId)}>
                                                                        <div className="flex items-start justify-between gap-3">
                                                                            <div className="flex-1 min-w-0">
                                                                                <h4 className={`font-bold text-lg mb-1 ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>{task.title}</h4>
                                                                                <div className="flex items-center gap-2 flex-wrap">
                                                                                    <span className={`px-2 py-1 rounded text-xs font-semibold ${globalDarkMode ? 'bg-purple-900/50 text-purple-300' : 'bg-purple-100 text-purple-700'}`}>{task.projectName}</span>
                                                                                    <span className={`px-2 py-1 rounded text-xs ${globalDarkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'}`}>{task.category}</span>
                                                                                </div>
                                                                            </div>
                                                                            <div className="flex flex-col items-end gap-1">
                                                                                <span className={`px-3 py-1 rounded-lg text-xs font-bold text-white whitespace-nowrap ${urgencyColor}`}>{urgencyText}</span>
                                                                                <span className={`text-xs ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>{deadline.toLocaleDateString()}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}
                                        
                                        <div className={dashboardLayoutStyle === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' : 'space-y-4'}>
                                            {projects.filter(project => {
                                                if (!dashboardSearchQuery) return true;
                                                return project.name.toLowerCase().includes(dashboardSearchQuery.toLowerCase());
                                            }).map(project => {
                                            const projectTasks = getAllTasks(project.tasks || []);
                                            const completedTasks = projectTasks.filter(t => t.completed).length;
                                            const progress = projectTasks.length > 0 ? (completedTasks / projectTasks.length) * 100 : 0;
                                            
                                                if (dashboardLayoutStyle === 'list') {
                                                    const isEditing = editingDashboardProject === project.id;
                                            return (
                                                        <div key={project.id} className={`border-2 rounded-2xl p-6 transition-all ${isEditing ? '' : 'hover:shadow-xl cursor-pointer hover-lift'} ${globalDarkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-white'} ${!isEditing && (globalDarkMode ? 'hover:bg-gray-750' : 'hover:bg-gray-50')}`} onClick={() => !isEditing && switchProject(project.id)}>
                                                            <div className="flex items-center gap-6">
                                                                <div className="flex-1">
                                                                    {isEditing ? (
                                                                        <div className="space-y-3 mb-3">
                                                                            <input 
                                                                                type="text" 
                                                                                value={editingDashboardProjectName} 
                                                                                onChange={(e) => setEditingDashboardProjectName(e.target.value)}
                                                                                className={`w-full px-4 py-2 border-2 rounded-xl text-2xl font-bold ${globalDarkMode ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'}`}
                                                                                placeholder="Project name..."
                                                                                onClick={(e) => e.stopPropagation()}
                                                                            />
                                                                            <textarea 
                                                                                value={editingDashboardProjectDescription} 
                                                                                onChange={(e) => setEditingDashboardProjectDescription(e.target.value)} 
                                                                                className={`w-full px-4 py-2 border-2 rounded-xl text-sm resize-none ${globalDarkMode ? 'bg-gray-700 text-gray-300 border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'}`} 
                                                                                placeholder="Add a project description (optional)..."
                                                                                rows="2"
                                                                                onClick={(e) => e.stopPropagation()}
                                                                            />
                                                                            <input 
                                                                                type="date" 
                                                                                value={editingDashboardProjectDeadline} 
                                                                                onChange={(e) => setEditingDashboardProjectDeadline(e.target.value)} 
                                                                                className={`w-full px-4 py-2 border-2 rounded-xl text-sm ${globalDarkMode ? 'bg-gray-700 text-gray-300 border-gray-600' : 'border-gray-300'}`}
                                                                                onClick={(e) => e.stopPropagation()}
                                                                            />
                                                                            <div className="flex gap-2">
                                                                                <button onClick={(e) => {e.stopPropagation(); saveDashboardProjectEdit();}} className={`px-4 py-2 rounded-xl font-semibold text-white`} style={{ background: `linear-gradient(135deg, ${dashboardPrimaryColor}, ${dashboardSecondaryColor})` }}>
                                                                                    <Check className="w-5 h-5" />
                                                                                </button>
                                                                                <button onClick={(e) => {e.stopPropagation(); cancelDashboardProjectEdit();}} className={`px-4 py-2 rounded-xl ${globalDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}>
                                                                                    <X className="w-5 h-5" />
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    ) : (
                                                                        <>
                                                                            <div className="flex items-center justify-between mb-3">
                                                                                <h3 className={`text-3xl font-bold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>{project.name}</h3>
                                                                                <div className="flex gap-2">
                                                                                    <button onClick={(e) => {e.stopPropagation(); startEditingDashboardProject(project);}} className={`p-2 rounded-lg ${globalDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`} style={{ color: dashboardPrimaryColor }}>
                                                                                        <Edit2 className="w-5 h-5" />
                                                                                    </button>
                                                                                    <button onClick={(e) => {e.stopPropagation(); deleteProject(project.id, project.name);}} className="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                                                                        <Trash2 className="w-5 h-5" />
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                            {project.description && (
                                                                                <p className={`text-sm mb-2 line-clamp-1 ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>{project.description}</p>
                                                                            )}
                                                                            {project.deadline && (
                                                                                <div className="flex items-center gap-1 mb-3">
                                                                                    <Calendar className={`w-3 h-3 ${globalDarkMode ? 'text-gray-500' : 'text-gray-500'}`} />
                                                                                    <span className={`text-xs ${globalDarkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                                                                                        {new Date(project.deadline).toLocaleDateString()}
                                                                                    </span>
                                                                                </div>
                                                                            )}
                                                                        </>
                                                                    )}
                                                                    {!isEditing && (
                                                                        <div className="flex gap-6 items-center">
                                                                        <div className="flex gap-4 text-sm">
                                                                            <span className={globalDarkMode ? 'text-gray-400' : 'text-gray-600'}><span className="font-bold">{projectTasks.length}</span> tasks</span>
                                                                            <span className={globalDarkMode ? 'text-gray-400' : 'text-gray-600'}><span className="font-bold">{completedTasks}</span> completed</span>
                                                                        </div>
                                                                        <div className="flex gap-2 flex-wrap">
                                                                            {['Story', 'Art', 'Programming', 'Sound'].map(cat => {
                                                                                const catCount = projectTasks.filter(t => t.category === cat).length;
                                                                                if (catCount === 0) return null;
                                                                                return <span key={cat} className={`px-2 py-1 rounded text-xs ${globalDarkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'}`}>{cat}: {catCount}</span>;
                                                                            })}
                                                                        </div>
                                                                    </div>
                                                                    )}
                                                                </div>
                                                                {!isEditing && (
                                                                    <div className="w-64">
                                                                        <div className="flex justify-between items-center mb-2">
                                                                            <span className={`text-sm font-medium ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>Progress</span>
                                                                            <span className={`text-2xl font-bold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>{progress.toFixed(1)}%</span>
                                                                        </div>
                                                                        <div className={`w-full h-3 rounded-full ${globalDarkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                                                                            <div className="h-3 rounded-full transition-all" style={{ width: `${progress}%`, background: `linear-gradient(90deg, ${dashboardPrimaryColor}, ${dashboardSecondaryColor})` }} />
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    );
                                                }
                                            
                                            const isEditing = editingDashboardProject === project.id;
                                            return (
                                                    <div key={project.id} className={`border-2 rounded-2xl p-6 transition-all ${isEditing ? '' : 'hover:shadow-xl cursor-pointer hover-lift'} ${globalDarkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-white'} ${!isEditing && (globalDarkMode ? 'hover:bg-gray-750' : 'hover:bg-gray-50')}`} onClick={() => !isEditing && switchProject(project.id)}>
                                                    {isEditing ? (
                                                        <div className="space-y-3">
                                                            <input 
                                                                type="text" 
                                                                value={editingDashboardProjectName} 
                                                                onChange={(e) => setEditingDashboardProjectName(e.target.value)}
                                                                className={`w-full px-4 py-2 border-2 rounded-xl text-xl font-bold ${globalDarkMode ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'}`}
                                                                placeholder="Project name..."
                                                                onClick={(e) => e.stopPropagation()}
                                                            />
                                                            <textarea 
                                                                value={editingDashboardProjectDescription} 
                                                                onChange={(e) => setEditingDashboardProjectDescription(e.target.value)} 
                                                                className={`w-full px-4 py-2 border-2 rounded-xl text-sm resize-none ${globalDarkMode ? 'bg-gray-700 text-gray-300 border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'}`} 
                                                                placeholder="Add a project description (optional)..."
                                                                rows="3"
                                                                onClick={(e) => e.stopPropagation()}
                                                            />
                                                            <input 
                                                                type="date" 
                                                                value={editingDashboardProjectDeadline} 
                                                                onChange={(e) => setEditingDashboardProjectDeadline(e.target.value)} 
                                                                className={`w-full px-4 py-2 border-2 rounded-xl text-sm ${globalDarkMode ? 'bg-gray-700 text-gray-300 border-gray-600' : 'border-gray-300'}`}
                                                                onClick={(e) => e.stopPropagation()}
                                                            />
                                                            <div className="flex gap-2">
                                                                <button onClick={(e) => {e.stopPropagation(); saveDashboardProjectEdit();}} className={`flex-1 px-4 py-2 rounded-xl font-semibold text-white flex items-center justify-center gap-2`} style={{ background: `linear-gradient(135deg, ${dashboardPrimaryColor}, ${dashboardSecondaryColor})` }}>
                                                                    <Check className="w-5 h-5" />
                                                                    Save
                                                                </button>
                                                                <button onClick={(e) => {e.stopPropagation(); cancelDashboardProjectEdit();}} className={`px-4 py-2 rounded-xl ${globalDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}>
                                                                    <X className="w-5 h-5" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <>
                                                    <div className="flex items-start justify-between mb-4">
                                                        <h3 className={`text-2xl font-bold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>{project.name}</h3>
                                                                <div className="flex gap-2">
                                                                    <button onClick={(e) => {e.stopPropagation(); startEditingDashboardProject(project);}} className={`p-2 rounded-lg ${globalDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`} style={{ color: dashboardPrimaryColor }}>
                                                                        <Edit2 className="w-4 h-4" />
                                                                    </button>
                                                                    <button onClick={(e) => {e.stopPropagation(); deleteProject(project.id, project.name);}} className="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                            </div>
                                                            {project.description && (
                                                                <p className={`text-sm mb-2 line-clamp-1 ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>{project.description}</p>
                                                            )}
                                                            {project.deadline && (
                                                                <div className="flex items-center gap-1 mb-4">
                                                                    <Calendar className={`w-3 h-3 ${globalDarkMode ? 'text-gray-500' : 'text-gray-500'}`} />
                                                                    <span className={`text-xs ${globalDarkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                                                                        {new Date(project.deadline).toLocaleDateString()}
                                                                    </span>
                                                                </div>
                                                            )}
                                                    <div className="space-y-3">
                                                        <div className="flex justify-between text-sm">
                                                            <span className={globalDarkMode ? 'text-gray-400' : 'text-gray-600'}>{projectTasks.length} tasks</span>
                                                            <span className={globalDarkMode ? 'text-gray-400' : 'text-gray-600'}>{completedTasks} completed</span>
                                                            </div>
                                                            <div>
                                                                <div className="flex justify-between items-center mb-1">
                                                                    <span className={`text-xs font-medium ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>Progress</span>
                                                                    <span className={`text-lg font-bold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>{progress.toFixed(1)}%</span>
                                                        </div>
                                                        <div className={`w-full h-2 rounded-full ${globalDarkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                                                                    <div className="h-2 rounded-full transition-all" style={{ width: `${progress}%`, background: `linear-gradient(90deg, ${dashboardPrimaryColor}, ${dashboardSecondaryColor})` }} />
                                                                </div>
                                                        </div>
                                                        <div className="flex gap-2 flex-wrap">
                                                            {['Story', 'Art', 'Programming', 'Sound'].map(cat => {
                                                                const catCount = projectTasks.filter(t => t.category === cat).length;
                                                                if (catCount === 0) return null;
                                                                return <span key={cat} className={`px-2 py-1 rounded text-xs ${globalDarkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'}`}>{cat}: {catCount}</span>;
                                                            })}
                                                        </div>
                                                    </div>
                                                        </>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    </>
                                )}
                                    </>
                                ) : (
                                    /* Future Ideas Section */
                                    futureIdeas.length === 0 ? (
                                        <div className={`text-center py-20 ${globalDarkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                                            <p className="text-2xl mb-4">No ideas yet</p>
                                            <p className="text-lg">Click "New Idea" to add your first idea!</p>
                            </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {futureIdeas.filter(idea => {
                                                if (!dashboardSearchQuery) return true;
                                                return idea.name.toLowerCase().includes(dashboardSearchQuery.toLowerCase()) ||
                                                       (idea.description && idea.description.toLowerCase().includes(dashboardSearchQuery.toLowerCase()));
                                            }).map(idea => (
                                                <div key={idea.id} className={`border-2 rounded-2xl p-6 transition-all ${globalDarkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-white'}`}>
                                                    {editingIdea === idea.id ? (
                                                        <div className="space-y-3">
                                                            <input 
                                                                type="text" 
                                                                value={editingIdeaName}
                                                                onChange={(e) => setEditingIdeaName(e.target.value)}
                                                                className={`w-full px-3 py-2 border-2 rounded-xl text-lg font-bold ${globalDarkMode ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'}`}
                                                                autoFocus
                                                            />
                                                            <textarea 
                                                                value={editingIdeaDescription}
                                                                onChange={(e) => setEditingIdeaDescription(e.target.value)}
                                                                className={`w-full px-3 py-2 border-2 rounded-xl resize-none ${globalDarkMode ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'}`}
                                                                rows="4"
                                                            />
                                                            <div className="flex gap-2">
                                                                <button onClick={saveIdeaEdit} className={`flex-1 px-4 py-2 rounded-xl font-semibold text-white flex items-center justify-center gap-2`} style={{ background: `linear-gradient(135deg, ${dashboardPrimaryColor}, ${dashboardSecondaryColor})` }}>
                                                                    <Check className="w-5 h-5" />
                                                                    Save
                                                                </button>
                                                                <button onClick={cancelIdeaEdit} className={`px-4 py-2 rounded-xl ${globalDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}>
                                                                    <X className="w-5 h-5" />
                                                                </button>
                        </div>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <div className="flex items-start justify-between mb-3">
                                                                <h3 className={`text-2xl font-bold ${globalDarkMode ? 'text-white' : 'text-gray-800'}`}>{idea.name}</h3>
                                                                <div className="flex gap-2">
                                                                    <button onClick={() => startEditingIdea(idea)} className={`p-2 rounded-lg ${globalDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`} style={{ color: dashboardPrimaryColor }}>
                                                                        <Edit2 className="w-4 h-4" />
                                                                    </button>
                                                                    <button onClick={() => deleteIdea(idea.id, idea.name)} className="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                                                        <Trash2 className="w-4 h-4" />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            {idea.description && (
                                                                <p className={`text-sm line-clamp-1 ${globalDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>{idea.description}</p>
                                                            )}
                                                            <p className={`text-xs mt-4 ${globalDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                                                Added: {new Date(idea.createdAt).toLocaleDateString()}
                                                            </p>
                                                        </>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )
                                )}
                            </div>
                        </div>
                    
                    {/* Toast Notifications */}
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {/* Confirmation Dialog */}
                    {confirmDialog && <ConfirmDialog {...confirmDialog} darkMode={globalDarkMode} />}
                    </div>
                );
            }

            return (
                <div className={`min-h-screen p-6 ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-purple-50 to-pink-50'}`}>
                    <DynamicBackground darkMode={darkMode} />
                    {renderHeaderLogo()}
                    <div className="max-w-7xl mx-auto content-wrapper" style={{ paddingTop: '180px' }}>
                        <div className={`rounded-3xl shadow-2xl p-8 mb-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex-1 flex items-center gap-4">
                                    <button onClick={() => {
                                        // Return to dashboard (auto-save will handle saving)
                                        setCurrentProjectId(null);
                                    }} className={`px-4 py-3 rounded-xl font-semibold flex items-center gap-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                                        ← Projects
                                    </button>
                                    {editingProject ? (
                                        <div className="flex-1 max-w-2xl">
                                            <div className="flex gap-3 items-start">
                                                <div className="flex-1">
                                                    <input type="text" value={projectName} onChange={(e) => setProjectName(e.target.value)} className={`w-full px-4 py-2 border-2 rounded-xl text-2xl font-bold mb-2 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'border-gray-300'}`} placeholder="Project Name" />
                                                    <textarea 
                                                        value={projectDescription} 
                                                        onChange={(e) => setProjectDescription(e.target.value)} 
                                                        className={`w-full px-4 py-2 border-2 rounded-xl text-sm resize-none mb-2 ${darkMode ? 'bg-gray-700 text-gray-300 border-gray-600 placeholder-gray-500' : 'border-gray-300 placeholder-gray-400'}`} 
                                                        placeholder="Add a project description (optional)..."
                                                        rows="2"
                                                    />
                                                    <input 
                                                        type="date" 
                                                        value={projectDeadline} 
                                                        onChange={(e) => setProjectDeadline(e.target.value)} 
                                                        className={`w-full px-4 py-2 border-2 rounded-xl text-sm ${darkMode ? 'bg-gray-700 text-gray-300 border-gray-600' : 'border-gray-300'}`}
                                                        placeholder="Project Deadline"
                                                    />
                                                </div>
                                            <button onClick={() => {
                                                // Save project data when finishing editing
                                                const updatedProjects = projects.map(p => {
                                                    if (p.id === currentProjectId) {
                                                        return {
                                                            ...p,
                                                            name: projectName,
                                                            description: projectDescription,
                                                            deadline: projectDeadline
                                                        };
                                                    }
                                                    return p;
                                                });
                                                setProjects(updatedProjects);
                                                setEditingProject(false);
                                            }} className="px-4 py-2 text-white rounded-xl" style={{ backgroundColor: primaryColor }}><Check className="w-6 h-6" /></button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                        <div className="flex items-center gap-3">
                                                <h1 className={`text-4xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                {projectName}
                                            </h1>
                                                <button onClick={() => setEditingProject(true)} style={{ color: primaryColor }} title="Edit Project"><Edit2 className="w-6 h-6" /></button>
                                            <button onClick={() => setShowProjectSelector(!showProjectSelector)} className={`p-2 rounded-xl ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`} style={{ color: primaryColor }} title="Switch Project">
                                                <Layout className="w-6 h-6" />
                                            </button>
                                            {showProjectSelector && (
                                                <div className={`absolute top-24 left-8 w-64 p-4 rounded-xl shadow-2xl z-50 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-2`}>
                                                    <div className="space-y-2">
                                                        {projects.map(p => (
                                                            <div key={p.id} className="flex items-center justify-between">
                                                                <button onClick={() => switchProject(p.id)} className={`flex-1 text-left px-3 py-2 rounded-lg transition-all ${currentProjectId === p.id ? 'text-white' : darkMode ? 'text-gray-300' : 'text-gray-700'}`} style={currentProjectId === p.id ? { backgroundColor: primaryColor } : {}}>
                                                                    {p.name}
                                                                </button>
                                                                {projects.length > 1 && (
                                                                    <button onClick={() => deleteProject(p.id, p.name)} className="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                                                        <Trash2 className="w-4 h-4" />
                                                                    </button>
                                                                )}
                                                            </div>
                                                        ))}
                                                        {showNewProjectInput ? (
                                                            <div className="flex gap-2">
                                                                <input type="text" value={newProjectName} onChange={(e) => setNewProjectName(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && createNewProject()} className={`flex-1 px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white border-gray-300'}`} placeholder="Project name" autoFocus />
                                                                <button onClick={createNewProject} className="px-3 py-2 text-white rounded-lg" style={{ backgroundColor: primaryColor }}><Plus className="w-4 h-4" /></button>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => setShowNewProjectInput(true)} className={`w-full px-3 py-2 rounded-lg text-left ${darkMode ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-600 hover:bg-gray-100'}`}>
                                                                <Plus className="w-4 h-4 inline mr-2" /> New Project
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                            </div>
                                            {projectDeadline && (
                                                <div className="flex items-center gap-2 mt-2">
                                                    <Calendar className={`w-4 h-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} />
                                                    <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                        Deadline: {new Date(projectDeadline).toLocaleDateString()}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => {setDarkMode(!globalDarkMode); setGlobalDarkMode(!globalDarkMode);}} className={`p-3 rounded-xl ${globalDarkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-100'}`}>
                                        {globalDarkMode ? <Moon className="w-6 h-6" /> : <Sun className="w-6 h-6" />}
                                    </button>
                                    <button onClick={() => setLayoutStyle(layoutStyle === 'horizontal' ? 'sidebar' : 'horizontal')} className={`p-3 rounded-xl ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`} title="Toggle Layout">
                                        {layoutStyle === 'horizontal' ? <Sidebar className="w-6 h-6" style={{ color: primaryColor }} /> : <Layout className="w-6 h-6" style={{ color: primaryColor }} />}
                                    </button>
                                    <button onClick={() => setShowSearch(!showSearch)} className={`p-3 rounded-xl ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`} title="Search Tasks (Ctrl+K)">
                                        <Search className="w-6 h-6" style={{ color: primaryColor }} />
                                    </button>
                                    <button onClick={() => setShowStatistics(!showStatistics)} className={`p-3 rounded-xl ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`} title="Statistics (Ctrl+S)">
                                        <BarChart className="w-6 h-6" style={{ color: primaryColor }} />
                                    </button>
                                    <button onClick={() => {
                                        setShowMembersModal(!showMembersModal);
                                        if (!showMembersModal) loadProjectMembers(currentProjectId);
                                    }} className={`p-3 rounded-xl ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`} title="Manage Members">
                                        <Users className="w-6 h-6" style={{ color: primaryColor }} />
                                    </button>
                                    <button onClick={() => setShowSettings(!showSettings)} className="p-3 rounded-xl" style={{ backgroundColor: darkMode ? '#374151' : '#f3f4f6', color: primaryColor }}><Settings className="w-6 h-6" /></button>
                                </div>
                            </div>

                            {showSettings && (
                                <div className={`mb-6 p-6 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                    <h3 className={`font-bold mb-4 ${darkMode ? 'text-white' : ''}`}>Project Settings</h3>
                                    <div className="mb-6">
                                        <h4 className={`font-semibold mb-3 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Colors</h4>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={`text-sm mb-2 block ${darkMode ? 'text-gray-300' : ''}`}>Primary</label>
                                            <input type="color" value={primaryColor} onChange={(e) => setPrimaryColor(e.target.value)} className="w-full h-12 rounded-xl" />
                                        </div>
                                        <div>
                                            <label className={`text-sm mb-2 block ${darkMode ? 'text-gray-300' : ''}`}>Secondary</label>
                                            <input type="color" value={secondaryColor} onChange={(e) => setSecondaryColor(e.target.value)} className="w-full h-12 rounded-xl" />
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 className={`font-semibold mb-3 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Data Management</h4>
                                        <div className="flex gap-3">
                                            <button onClick={exportData} className={`flex-1 px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-white hover:bg-gray-50 border-2 border-gray-300'}`}>
                                                <Download className="w-5 h-5" />
                                                Export Data
                                            </button>
                                            <label className={`flex-1 px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 cursor-pointer ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-white hover:bg-gray-50 border-2 border-gray-300'}`}>
                                                <Upload className="w-5 h-5" />
                                                Import Data
                                                <input type="file" accept=".json" onChange={importData} className="hidden" />
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Search and Sort Controls */}
                            <div className="mb-6 flex gap-3 items-start justify-between">
                                <div className="flex-1 max-w-2xl">
                                    {projectDescription && !showSearch && (
                                        <div className={`px-4 py-3 rounded-xl border-l-4 ${darkMode ? 'bg-gray-800/50 border-purple-500/50 text-gray-300' : 'bg-gradient-to-r from-purple-50 to-pink-50 border-purple-400 text-gray-700'}`}>
                                            <div className="flex items-center gap-2 mb-1">
                                                <FileText className={`w-4 h-4 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`} />
                                                <span className={`text-xs font-semibold uppercase tracking-wide ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>Project Description</span>
                                            </div>
                                            <p className={`text-base leading-relaxed break-words line-clamp-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{projectDescription}</p>
                                        </div>
                                    )}
                                    {showSearch && (
                                        <div className="animate-scale-in">
                                            <div className="relative">
                                                <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} />
                                                <input 
                                                    type="text" 
                                                    value={searchQuery} 
                                                    onChange={(e) => setSearchQuery(e.target.value)}
                                                    placeholder="Search tasks..."
                                                    className={`w-full pl-10 pr-10 py-3 rounded-xl border-2 ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 placeholder-gray-500'}`}
                                                    autoFocus
                                                />
                                                {searchQuery && (
                                                    <button onClick={() => setSearchQuery('')} className={`absolute right-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-700'}`}>
                                                        <X className="w-5 h-5" />
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-3 flex-shrink-0">
                                    <div className="relative">
                                        <select 
                                            value={sortBy} 
                                            onChange={(e) => setSortBy(e.target.value)}
                                            className={`px-4 py-3 rounded-xl border-2 font-semibold appearance-none pr-10 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}
                                        >
                                            <option value="priority">Sort by Priority</option>
                                            <option value="deadline">Sort by Deadline</option>
                                            <option value="name">Sort by Name</option>
                                        </select>
                                        <ArrowUpDown className={`absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 pointer-events-none ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Members Modal */}
                            {showMembersModal && (
                                <div className={`mb-6 p-6 rounded-xl animate-scale-in ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>👥 Project Members</h3>
                                        <button onClick={() => setShowMembersModal(false)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-600' : 'hover:bg-gray-200'}`}>
                                            <X className="w-5 h-5" />
                                        </button>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        {/* Current Project Owner */}
                                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: primaryColor }}>
                                                        <span className="text-white font-bold">{user.email[0].toUpperCase()}</span>
                                                    </div>
                                                    <div>
                                                        <p className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{user.email}</p>
                                                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Owner</p>
                                                    </div>
                                                </div>
                                                <span className="px-3 py-1 rounded-lg text-xs font-bold text-white" style={{ backgroundColor: primaryColor }}>You</span>
                                            </div>
                                        </div>

                                        {/* Other Members */}
                                        {loadingMembers ? (
                                            <div className={`text-center py-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Loading members...
                                            </div>
                                        ) : projectMembers.length === 0 ? (
                                            <div className={`text-center py-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                No other members yet. Invite someone to collaborate!
                                            </div>
                                        ) : (
                                            projectMembers.map(member => (
                                                <div key={member.id} className={`p-4 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                                                                <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                                    {member.username?.[0]?.toUpperCase() || 'U'}
                                                                </span>
                                                            </div>
                                                            <div>
                                                                <p className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                                    @{member.username || 'Unknown User'}
                                                                </p>
                                                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                    {member.role === 'owner' ? 'Owner' : 'Member'}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => removeProjectMember(member.id)}
                                                            className="text-red-600 hover:bg-red-50 p-2 rounded-lg"
                                                        >
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))
                                        )}

                                        {/* Add Member */}
                                        <div className={`p-4 rounded-lg border-2 border-dashed ${darkMode ? 'border-gray-600 bg-gray-800/50' : 'border-gray-300 bg-white/50'}`}>
                                            <h4 className={`font-semibold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Invite Member</h4>
                                            <div className="flex gap-3">
                                                <input 
                                                    type="text"
                                                    value={newMemberUsername}
                                                    onChange={(e) => setNewMemberUsername(e.target.value)}
                                                    placeholder="Enter username..."
                                                    className={`flex-1 px-4 py-3 border-2 rounded-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 placeholder-gray-500'}`}
                                                />
                                                <button 
                                                    onClick={() => addProjectMember(newMemberUsername)}
                                                    className="px-6 py-3 text-white rounded-xl font-semibold hover:scale-105 transition-transform"
                                                    style={{ background: `linear-gradient(135deg, ${primaryColor}, ${secondaryColor})` }}
                                                >
                                                    Invite
                                                </button>
                                            </div>
                                            <p className={`text-xs mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                They'll receive an invitation they can accept or decline.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Statistics Panel */}
                            {showStatistics && (
                                <div className={`mb-6 p-6 rounded-xl animate-scale-in ${darkMode ? 'bg-gradient-to-br from-purple-900/30 to-pink-900/30 border-2 border-purple-500/50' : 'bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200'}`}>
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>📊 Project Statistics</h3>
                                        <button onClick={() => setShowStatistics(false)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-white/50'}`}>
                                            <X className="w-5 h-5" />
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {(() => {
                                            const allTasks = getAllTasks(tasks);
                                            const completedCount = allTasks.filter(t => t.completed).length;
                                            const withDeadlines = allTasks.filter(t => t.deadline && !t.completed).length;
                                            const overdue = allTasks.filter(t => t.deadline && !t.completed && new Date(t.deadline) < new Date()).length;
                                            
                                            const stats = [
                                                { label: 'Total Tasks', value: allTasks.length, icon: '📝', color: 'blue' },
                                                { label: 'Completed', value: completedCount, icon: '✅', color: 'green' },
                                                { label: 'With Deadlines', value: withDeadlines, icon: '📅', color: 'purple' },
                                                { label: 'Overdue', value: overdue, icon: '⚠️', color: 'red' }
                                            ];
                                            
                                            return stats.map((stat, idx) => (
                                                <div key={idx} className={`p-4 rounded-xl ${darkMode ? 'bg-gray-800/50' : 'bg-white/70'}`}>
                                                    <div className="text-3xl mb-2">{stat.icon}</div>
                                                    <div className={`text-3xl font-bold mb-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{stat.value}</div>
                                                    <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{stat.label}</div>
                                                </div>
                                            ));
                                        })()}
                                    </div>
                                    <div className="mt-6 grid grid-cols-1 md:grid-cols-5 gap-4">
                                        {CATEGORIES.map(cat => {
                                            const catTasks = tasks.filter(t => t.category === cat);
                                            const catCompleted = catTasks.filter(t => t.completed).length;
                                            const catProgress = catTasks.length > 0 ? (catCompleted / catTasks.length) * 100 : 0;
                                            
                                            return (
                                                <div key={cat} className={`p-4 rounded-xl ${darkMode ? 'bg-gray-800/50' : 'bg-white/70'}`}>
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <div style={{ color: primaryColor }}>{getCategoryIcon(cat)}</div>
                                                        <div className={`font-semibold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>{cat}</div>
                                                    </div>
                                                    <div className={`text-2xl font-bold mb-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{catTasks.length}</div>
                                                    <div className={`w-full h-2 rounded-full ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                                                        <div className="h-2 rounded-full transition-all" style={{ width: `${catProgress}%`, backgroundColor: primaryColor }} />
                                                    </div>
                                                    <div className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{catProgress.toFixed(0)}% done</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {layoutStyle === 'horizontal' && (
                                <>
                                    <div className="mb-6">
                                        <div className="flex justify-between mb-2">
                                            <span className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Progress</span>
                                            <span className={`text-lg font-bold ${darkMode ? 'text-white' : ''}`}>{progress.toFixed(1)}%</span>
                                        </div>
                                        <div className={`w-full h-4 rounded-full ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                                            <div className="h-4 rounded-full" style={{ width: `${progress}%`, background: `linear-gradient(90deg, ${primaryColor}, ${secondaryColor})` }} />
                                        </div>
                                    </div>

                                    <div className="flex gap-3 flex-wrap mb-6">
                                        <button onClick={() => setSelectedCategory('All')} className={`px-5 py-3 rounded-xl font-semibold transition-all ${selectedCategory === 'All' ? 'text-white' : darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100'}`} style={selectedCategory === 'All' ? { background: `linear-gradient(135deg, ${primaryColor}, ${secondaryColor})` } : {}}>All</button>
                                        {CATEGORIES.map(cat => (
                                            <button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-5 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 ${selectedCategory === cat ? 'text-white' : darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100'}`} style={selectedCategory === cat ? { background: `linear-gradient(135deg, ${primaryColor}, ${secondaryColor})` } : {}}>
                                                {getCategoryIcon(cat)}
                                                {cat}
                                            </button>
                                        ))}
                                    </div>

                                    <div className={`rounded-3xl shadow-2xl p-8 mb-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                        {renderHorizontalLayout()}
                                    </div>
                                </>
                            )}
                            
                            {layoutStyle === 'sidebar' && !isCategoryView && (
                                <div className="grid grid-cols-12 gap-6">
                                    <div className="col-span-3 space-y-3">
                                        <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                            <h3 className={`font-bold text-lg mb-3 ${darkMode ? 'text-white' : ''}`}>Categories</h3>
                                            <div className="space-y-2">
                                                <button onClick={() => setSelectedCategory('All')} className={`w-full text-left px-4 py-2 rounded-lg transition-all ${selectedCategory === 'All' ? 'text-white' : darkMode ? 'text-gray-300' : 'text-gray-700'}`} style={selectedCategory === 'All' ? { backgroundColor: primaryColor } : {}}>All</button>
                                                {CATEGORIES.map(cat => (
                                                    <button key={cat} onClick={() => setSelectedCategory(cat)} className={`w-full text-left px-4 py-2 rounded-lg transition-all flex items-center gap-2 ${selectedCategory === cat ? 'text-white' : darkMode ? 'text-gray-300' : 'text-gray-700'}`} style={selectedCategory === cat ? { backgroundColor: primaryColor } : {}}>
                                                        {getCategoryIcon(cat)}
                                                        {cat}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                            <div className="flex items-center justify-between mb-2">
                                                <span className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Progress</span>
                                                <span className={`text-lg font-bold ${darkMode ? 'text-white' : ''}`}>{progress.toFixed(1)}%</span>
                                            </div>
                                            <div className={`w-full h-2 rounded-full ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                                                <div className="h-full rounded-full transition-all duration-300" style={{ width: `${progress}%`, background: `linear-gradient(to bottom, ${primaryColor}, ${secondaryColor})` }} />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="col-span-9">
                                        <div className="flex items-center justify-between mb-6">
                                            <h2 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>All Tasks</h2>
                                        </div>
                                        {tasks.length === 0 ? (
                                            <div className={`text-center py-16 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                                                <p className="text-xl">No tasks yet. Select a category and add your first task!</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {getSortedTasks().map(task => (
                                                    <TaskItem key={task.id} task={task} onUpdate={(updated) => updateTask(task.id, updated)} onDelete={deleteTask} onToggle={toggleTask} level={0} colors={colors} darkMode={darkMode} />
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {layoutStyle === 'sidebar' && isCategoryView && (
                                <div className="grid grid-cols-12 gap-6">
                                    <div className="col-span-3 space-y-3">
                                        <button onClick={() => setSelectedCategory('All')} className={`w-full px-4 py-3 rounded-xl font-semibold transition-all ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}>← Back to All</button>
                                        <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                            <h3 className={`font-bold text-lg mb-3 ${darkMode ? 'text-white' : ''}`}>Categories</h3>
                                            <div className="space-y-2">
                                                <button onClick={() => setSelectedCategory('All')} className={`w-full text-left px-4 py-2 rounded-lg transition-all ${selectedCategory === 'All' ? 'text-white' : darkMode ? 'text-gray-300' : 'text-gray-700'}`} style={selectedCategory === 'All' ? { backgroundColor: primaryColor } : {}}>All</button>
                                                {CATEGORIES.map(cat => (
                                                    <button key={cat} onClick={() => setSelectedCategory(cat)} className={`w-full text-left px-4 py-2 rounded-lg transition-all flex items-center gap-2 ${selectedCategory === cat ? 'text-white' : darkMode ? 'text-gray-300' : 'text-gray-700'}`} style={selectedCategory === cat ? { backgroundColor: primaryColor } : {}}>
                                                        {getCategoryIcon(cat)}
                                                        {cat}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                            <div className="flex items-center justify-between mb-2">
                                                <span className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Progress</span>
                                                <span className={`text-lg font-bold ${darkMode ? 'text-white' : ''}`}>{progress.toFixed(1)}%</span>
                                            </div>
                                            <div className={`w-full h-2 rounded-full ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                                                <div className="h-full rounded-full transition-all duration-300" style={{ width: `${progress}%`, background: `linear-gradient(to bottom, ${primaryColor}, ${secondaryColor})` }} />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="col-span-9">
                                        <div className="flex items-center justify-between mb-6">
                                            <h2 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{selectedCategory} Tasks</h2>
                                            <button onClick={() => addTask(selectedCategory)} className="px-6 py-3 text-white rounded-xl font-semibold flex items-center gap-2 shadow-lg hover:shadow-xl transition-all" style={{ background: `linear-gradient(135deg, ${primaryColor}, ${secondaryColor})` }}>
                                                <Plus className="w-5 h-5" /> Add {selectedCategory} Task
                                            </button>
                                        </div>
                                        {getSortedTasks().length === 0 ? (
                                            <div className={`text-center py-16 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                                                <p className="text-xl">No tasks in this category yet!</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {getSortedTasks().map(task => (
                                                    <TaskItem key={task.id} task={task} onUpdate={(updated) => updateTask(task.id, updated)} onDelete={deleteTask} onToggle={toggleTask} level={0} colors={colors} darkMode={darkMode} />
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Toast Notifications */}
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {/* Confirmation Dialog */}
                    {confirmDialog && <ConfirmDialog {...confirmDialog} darkMode={darkMode || globalDarkMode} />}
                </div>
            );
        }

        // Main App with Authentication
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // Check current session
                supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
                    if (session?.user) {
                        // Check if profile exists, if not create it from metadata
                        const { data: profile } = await supabaseClient
                            .from('user_profiles')
                            .select('username')
                            .eq('id', session.user.id)
                            .single();
                        
                        if (!profile && session.user.user_metadata?.username) {
                            // Create profile from signup metadata
                            await supabaseClient
                                .from('user_profiles')
                                .insert([{
                                    id: session.user.id,
                                    username: session.user.user_metadata.username
                                }]);
                        }
                    }
                    setUser(session?.user ?? null);
                    setLoading(false);
                });

                // Listen for auth changes
                const {
                    data: { subscription },
                } = supabaseClient.auth.onAuthStateChange(async (_event, session) => {
                    if (session?.user && _event === 'SIGNED_IN') {
                        // Check if profile exists, if not create it from metadata
                        const { data: profile } = await supabaseClient
                            .from('user_profiles')
                            .select('username')
                            .eq('id', session.user.id)
                            .single();
                        
                        if (!profile && session.user.user_metadata?.username) {
                            // Create profile from signup metadata
                            await supabaseClient
                                .from('user_profiles')
                                .insert([{
                                    id: session.user.id,
                                    username: session.user.user_metadata.username
                                }]);
                        }
                    }
                    setUser(session?.user ?? null);
                });

                return () => subscription.unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-900 flex items-center justify-center relative overflow-hidden">
                        <DynamicBackground darkMode={true} />
                        <div className="relative z-10 text-center">
                            <div className="mb-4">
                                <h1 className="text-6xl font-black text-white mb-2">TASK MANAGER</h1>
                                <span className="text-4xl">🎮</span>
                            </div>
                            <div className="flex items-center justify-center gap-2">
                                <div className="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                <div className="w-3 h-3 bg-pink-500 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                <div className="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <AuthPage onAuthSuccess={setUser} />;
            }

            return <GameDevTaskManager user={user} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>